<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WSS 隧道管理面板 - V2.3 移动优化版</title>
    <!-- 引入 Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 保持字体引入，使用 Inter */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        
        /* 仅保留功能性/不可替代的样式 */
        .log-pre { font-family: monospace; font-size: 0.8rem; white-space: pre; overflow-x: auto; max-height: 200px; }
        .status-dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 6px; }
        .status-active { background-color: #10b981; } /* Tailwind: green-500 */
        .status-paused { background-color: #f59e0b; } /* Tailwind: amber-500 */
        .status-expired { background-color: #ef4444; } /* Tailwind: red-500 */
        .ip-banned-tag { background-color: #fca5a5; color: #dc2626; font-weight: 600; } /* Tailwind: red-300 / red-700 */

        /* 优化主布局：使用 calc(100vh - header_height) 确保内容区域滚动 */
        .main-content-area {
            min-height: calc(100vh - 72px); /* 72px is the header height (py-4 + text-size) */
        }
        
        .card { transition: all 0.3s ease; }
        .card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px rgba(0,0,0,0.05); }
        .modal { position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.5); z-index: 1000; display: none; justify-content: center; align-items: center; }
        .modal > div { max-width: 90%; }
        
        /* 强制隐藏数字输入框的默认箭头，提高美观度 */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
          -webkit-appearance: none; 
          margin: 0; 
        }
        input[type=number] {
            -moz-appearance: textfield;
        }

    </style>
</head>
<body>

    <!-- Header / 导航栏 -->
    <header class="bg-indigo-700 shadow-lg sticky top-0 z-20">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-white tracking-wide">WSS 隧道管理面板 (V2.3 优化版)</h1>
            <button onclick="logout()" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 shadow-md">
                退出登录
            </button>
        </div>
    </header>

    <!-- 主布局：侧边栏 + 内容区 -->
    <div class="main-content-area max-w-7xl mx-auto flex">
        <!-- 侧边栏 (w-64, sticky) -->
        <aside class="w-64 bg-white shadow-xl flex-shrink-0 sticky top-[72px] h-[calc(100vh-72px)] overflow-y-auto hidden md:block border-r border-gray-100">
            <nav class="p-4 space-y-2">
                <!-- 导航链接：使用 ID 进行 JS 切换 -->
                <a onclick="switchView('dashboard')" class="nav-link block p-3 rounded-xl cursor-pointer text-indigo-700 font-semibold bg-indigo-100 hover:bg-indigo-200 transition duration-150" id="nav-dashboard">
                    📊 仪表盘 (Dashboard)
                </a>
                <a onclick="switchView('users')" class="nav-link block p-3 rounded-xl cursor-pointer text-gray-700 font-semibold hover:bg-gray-100 transition duration-150" id="nav-users">
                    👤 用户管理
                </a>
                <a onclick="switchView('live-ips')" class="nav-link block p-3 rounded-xl cursor-pointer text-gray-700 font-semibold hover:bg-gray-100 transition duration-150" id="nav-live-ips">
                    📡 实时连接 IP
                </a>
                <!-- NEW: Host 白名单导航 -->
                <a onclick="switchView('hosts')" class="nav-link block p-3 rounded-xl cursor-pointer text-gray-700 font-semibold hover:bg-gray-100 transition duration-150" id="nav-hosts">
                    ⚙️ Host 白名单
                </a>
                <a onclick="switchView('settings')" class="nav-link block p-3 rounded-xl cursor-pointer text-gray-700 font-semibold hover:bg-gray-100 transition duration-150" id="nav-settings">
                    🛠️ 系统配置/日志
                </a>
                <a onclick="switchView('security')" class="nav-link block p-3 rounded-xl cursor-pointer text-gray-700 font-semibold hover:bg-gray-100 transition duration-150" id="nav-security">
                    🔒 全局 IP 封禁列表
                </a>
            </nav>
        </aside>

        <!-- 内容区域 -->
        <main class="flex-grow p-4 sm:p-6 lg:p-8">
            
            <!-- 移动端导航选择器 (新增响应式组件) -->
            <div class="block md:hidden mb-6">
                <label for="mobile-view-select" class="sr-only">选择视图</label>
                <select id="mobile-view-select" onchange="switchView(this.value)" class="w-full p-3 border border-gray-300 rounded-lg bg-white text-gray-700 font-semibold focus:ring-indigo-500 focus:border-indigo-500 shadow-sm">
                    <option value="dashboard">📊 仪表盘 (Dashboard)</option>
                    <option value="users">👤 用户管理</option>
                    <option value="live-ips">📡 实时连接 IP</option>
                    <option value="hosts">⚙️ Host 白名单</option>
                    <option value="settings">🛠️ 系统配置/日志</option>
                    <option value="security">🔒 全局 IP 封禁列表</option>
                </select>
            </div>
            
            <!-- 全局状态信息/警告 -->
            <div id="status-message" class="hidden p-4 mb-6 rounded-xl font-medium border-l-4" role="alert"></div>

            <!-- 1. 仪表盘视图 (默认显示) -->
            <div id="view-dashboard" >
                <!-- 实时系统状态卡片 -->
                <section class="mb-8">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4">核心基础设施状态</h2>
                    <div id="system-status-grid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
                        <!-- 动态加载系统和组件状态 -->
                        <p class="text-gray-500 col-span-full">正在加载系统状态...</p>
                    </div>
                </section>
                
                <!-- 端口状态和核心操作 -->
                <section class="card bg-white p-6 rounded-xl shadow-lg mb-8">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">服务端口与控制</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div id="port-status-data" class="md:col-span-1 p-4 bg-gray-50 rounded-lg space-y-2 text-sm border">
                            <!-- 端口列表（动态加载） -->
                            <p class="text-gray-500">正在检查端口状态...</p>
                        </div>
                        <!-- 服务控制按钮：在小屏幕上，按钮会通过 space-y-3 垂直堆叠 -->
                        <div class="md:col-span-2 space-y-3">
                            <!-- NOTE: 使用 JS 动态获取端口，而不是 Flask 渲染 -->
                            <button onclick="confirmAction('wss', 'restart', null, 'serviceControl', '重启 WSS')" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition duration-200 shadow-md">
                                重启 WSS Proxy (<span id="wss-http-port"></span>/<span id="wss-tls-port"></span>)
                            </button>
                            <button onclick="confirmAction('stunnel4', 'restart', null, 'serviceControl', '重启 Stunnel4')" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition duration-200 shadow-md">
                                重启 Stunnel4 (<span id="stunnel-port"></span>)
                            </button>
                            <button onclick="confirmAction('udpgw', 'restart', null, 'serviceControl', '重启 UDPGW')" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition duration-200 shadow-md">
                                重启 UDPGW (<span id="udpgw-port"></span>)
                            </button>
                            <button onclick="confirmAction('wss_panel', 'restart', null, 'serviceControl', '重启面板')" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-lg transition duration-200 shadow-md">
                                重启 Web Panel (<span id="panel-port"></span>)
                            </button>
                        </div>
                    </div>
                </section>
                
                <!-- 快速用户统计（可作为仪表盘卡片） -->
                <section class="mb-8">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4">用户快速统计</h2>
                    <div id="user-quick-stats" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
                        <!-- 动态加载用户总数、活跃数等 -->
                    </div>
                </section>
            </div>

            <!-- 2. 用户管理视图 -->
            <div id="view-users" class="hidden">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">👤 用户管理</h2>
                
                <!-- 新增用户表单 -->
                <section class="card bg-white p-6 rounded-xl shadow-lg mb-8">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">新增 SSH 隧道用户</h3>
                    <!-- 🐛 修复：在小屏幕上强制堆叠，并添加标签 -->
                    <form id="add-user-form" class="grid grid-cols-1 md:grid-cols-6 gap-4 items-end">
                        <div class="md:col-span-2">
                             <label for="new-username" class="block text-sm font-medium text-gray-700 mb-1">用户名 (Username)</label>
                             <input type="text" id="new-username" placeholder="用户名 (Username)" required
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div class="md:col-span-2">
                            <label for="new-password" class="block text-sm font-medium text-gray-700 mb-1">密码 (Password)</label>
                            <input type="password" id="new-password" placeholder="密码 (Password)" required
                                   class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div class="md:col-span-1">
                             <label for="expiration-days" class="block text-sm font-medium text-gray-700 mb-1">有效期 (天)</label>
                             <input type="number" id="expiration-days" value="365" min="1" placeholder="有效期 (天)" required
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"
                                    aria-label="用户有效期，单位天">
                        </div>
                        
                        <div class="md:col-span-1">
                             <label for="quota-gb" class="block text-sm font-medium text-gray-700 mb-1">配额 (GB, 0=∞)</label>
                             <input type="number" id="quota-gb" value="0" min="0" placeholder="配额 (GB, 0=∞)" required
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"
                                    aria-label="用户流量配额，单位GB">
                        </div>
                        
                        <div class="md:col-span-2">
                             <label for="rate-kbps" class="block text-sm font-medium text-gray-700 mb-1">限速 (KB/s, 0=∞)</label>
                             <input type="number" id="rate-kbps" value="0" min="0" placeholder="限速 (KB/s, 0=∞)" required
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"
                                    aria-label="用户最大速度，单位KB/秒">
                        </div>
                        
                        <button type="submit" class="md:col-span-1 bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg transition duration-200 shadow-md">
                            创建用户
                        </button>
                        <!-- 占位符，保持布局 -->
                        <div class="md:col-span-3"></div>
                    </form>
                    <!-- 批量操作按钮 -->
                    <button onclick="openModal('batch-modal')" class="mt-4 bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-lg transition duration-200 text-sm shadow-md">
                        批量操作 / 续期 (待实现)
                    </button>
                </section>
                
                <!-- 用户列表 -->
                <section class="card bg-white p-6 rounded-xl shadow-lg">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">现有用户列表</h3>
                    <!-- 🐛 修复：在小屏幕上允许水平滚动 -->
                    <div class="overflow-x-auto border border-gray-200 rounded-lg">
                        <table class="min-w-full divide-y divide-gray-200" role="table">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" role="columnheader">用户</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" role="columnheader">状态</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" role="columnheader">到期日</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" role="columnheader">连接数</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" role="columnheader">用量/限额 (GB)</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" role="columnheader">限速 (KB/s)</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" role="columnheader">操作</th>
                                </tr>
                            </thead>
                            <tbody id="user-list-tbody" class="bg-white divide-y divide-gray-200">
                                <!-- 动态加载用户列表 -->
                            </tbody>
                        </table>
                    </div>
                </section>
            </div>
            
            <!-- 3. 实时连接 IP 列表视图 (NEW) -->
            <div id="view-live-ips" class="hidden">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">📡 实时连接 IP 列表</h2>
                <section class="card bg-white p-6 rounded-xl shadow-lg">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">当前连接到 WSS/Stunnel 端口的外部 IP</h3>
                    <div id="live-ip-list" class="space-y-3 max-h-96 overflow-y-auto p-3 bg-gray-50 rounded-lg border">
                        <p class="text-gray-500">正在加载实时 IP 数据...</p>
                    </div>
                    <p class="text-xs text-gray-500 mt-4">此列表显示 TCP ESTABLISHED 状态的连接 IP。请谨慎使用封禁功能。</p>
                </section>
            </div>

            <!-- 4. Host 白名单配置视图 (NEW) -->
            <div id="view-hosts" class="hidden">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">⚙️ WSS 代理 Host 白名单管理</h2>

                <section class="card bg-white p-6 rounded-xl shadow-lg">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">免流 Host 列表配置</h3>
                    <p class="text-sm text-gray-600 mb-4">WSS 代理（Http/Tls 端口）仅允许连接时请求的 Host 在此列表中的流量通过。用于运营商免流或定向流量识别。</p>
                    
                    <form onsubmit="event.preventDefault(); saveHosts();">
                        <textarea id="host-list-textarea" rows="10" placeholder="每行输入一个 Host 域名，例如：\ncmcc.com\n10086.cn\n..."
                                  class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 font-mono text-sm resize-none"></textarea>
                        
                        <div class="mt-4 flex justify-between items-center">
                            <p id="host-count-info" class="text-sm text-gray-500">当前加载 0 个 Host。</p>
                            <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg transition duration-200 shadow-md flex-shrink-0">
                                保存并重启 WSS 代理
                            </button>
                        </div>
                    </form>
                </section>
            </div>


            <!-- 5. 系统配置/日志视图 (原 3) -->
            <div id="view-settings" class="hidden">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">🛠️ 系统配置/日志</h2>

                <section class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="card bg-white p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">核心服务日志 (最新 50 行)</h3>
                        <div class="space-y-4">
                            <div class="flex space-x-2 flex-wrap">
                                <button onclick="fetchServiceLogs('wss')" class="bg-gray-200 hover:bg-gray-300 px-3 py-1 text-sm rounded-lg mb-2 shadow-sm">WSS Proxy</button>
                                <button onclick="fetchServiceLogs('stunnel4')" class="bg-gray-200 hover:bg-gray-300 px-3 py-1 text-sm rounded-lg mb-2 shadow-sm">Stunnel4</button>
                                <button onclick="fetchServiceLogs('udpgw')" class="bg-gray-200 hover:bg-gray-300 px-3 py-1 text-sm rounded-lg mb-2 shadow-sm">UDPGW</button>
                                <button onclick="fetchServiceLogs('wss_panel')" class="bg-gray-200 hover:bg-gray-300 px-3 py-1 text-sm rounded-lg mb-2 shadow-sm">Web Panel</button>
                            </div>
                            <div class="bg-gray-800 text-gray-200 p-3 rounded-lg overflow-hidden border border-gray-700">
                                <pre id="service-log-content" class="log-pre">请选择服务加载日志...</pre>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card bg-white p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">管理员审计日志 (最新活动)</h3>
                        <div class="bg-gray-100 p-3 rounded-lg max-h-[300px] overflow-y-auto border">
                             <div id="audit-log-content" class="text-xs text-gray-700 space-y-1">正在加载审计日志...</div>
                        </div>
                    </div>
                </section>
            </div>
            
            <!-- 6. 安全/IP 封禁列表视图 (原 4) -->
            <div id="view-security" class="hidden">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">🔒 全局 IP 封禁管理</h2>

                <section class="card bg-white p-6 rounded-xl shadow-lg mb-8">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">IPTables 全局封禁 IP 列表</h3>
                    <div id="global-ban-list" class="space-y-3 max-h-96 overflow-y-auto p-3 bg-gray-50 rounded-lg border">
                        <p class="text-gray-500">正在加载全局 IP 封禁列表...</p>
                    </div>
                </section>
                
                <section class="card bg-white p-6 rounded-xl shadow-lg">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">新增全局封禁 IP</h3>
                    <form id="add-global-ban-form" class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4">
                        <input type="text" id="global-ban-ip" placeholder="输入要封禁的 IP 地址" required
                                class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500">
                        <button type="submit" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg transition duration-200 shadow-md flex-shrink-0">
                            全局封禁
                        </button>
                    </form>
                </section>
            </div>

        </main>
    </div>

    <!-- 模态框：设置用户配额/速度/密码/有效期 -->
    <div id="settings-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 z-[1000] hidden justify-center items-center">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-lg transition duration-300 transform scale-100">
            <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">设置 <span id="modal-username-title-settings" class="text-indigo-600"></span> 的参数</h3>
            <form id="settings-form" onsubmit="event.preventDefault(); saveUserSettings();">
                <input type="hidden" id="modal-username-setting">
                
                <div class="space-y-4">
                    <div>
                        <label for="modal-expiry-date" class="block text-sm font-medium text-gray-700 mb-1">到期日期 (YYYY-MM-DD, 永不留空)</label>
                        <input type="date" id="modal-expiry-date" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="modal-quota-gb" class="block text-sm font-medium text-gray-700 mb-1">流量限额 (GB, 0=无限制)</label>
                            <input type="number" id="modal-quota-gb" min="0" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div>
                            <label for="modal-rate-kbps" class="block text-sm font-medium text-gray-700 mb-1">最大速度 (KB/s, 0=无限制)</label>
                            <input type="number" id="modal-rate-kbps" min="0" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                    </div>

                    <div class="border-t pt-4">
                        <label for="modal-new-password" class="block text-sm font-medium text-gray-700 mb-1">修改密码 (选填)</label>
                        <input type="password" id="modal-new-password" placeholder="留空则不修改" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                        <p class="text-xs text-gray-500 mt-1">注意：修改密码后，所有该用户当前活跃的连接将被强制断开。</p>
                    </div>
                </div>

                <div class="mt-6 flex justify-between">
                    <button type="button" onclick="confirmAction(document.getElementById('modal-username-setting').value, null, null, 'resetTraffic', '重置流量')" 
                            class="bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-200">重置流量</button>
                    <div class="flex space-x-3">
                        <button type="button" onclick="closeModal('settings-modal')" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg shadow-md transition duration-200">取消</button>
                        <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-200">保存设置</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    
    <!-- 模态框：SSH 活跃会话信息 (修改后的结构) -->
    <div id="session-info-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 z-[1000] hidden justify-center items-center">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-2xl transition duration-300 transform scale-100">
            <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">用户 <span id="session-modal-username-title" class="text-indigo-600"></span> 活跃 IP</h3>
            
            <div id="session-info-content" class="space-y-4">
                <div class="text-sm text-gray-600 pt-2">
                    <p class="font-bold">关联的外部连接 IP (ESTAB):</p>
                    <!-- IP 列表容器 (保留 ID for rendering) -->
                    <div id="session-ips" class="space-y-1 mt-2">正在加载 IP 信息...</div>
                </div>
            </div>
            
            <div class="mt-6 flex justify-between">
                <button onclick="confirmAction(document.getElementById('session-modal-username-title').textContent, null, null, 'killAll', '强制断开所有')" 
                        class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg text-sm shadow-md transition duration-200">
                    强制断开所有连接
                </button>
                <button type="button" onclick="closeModal('session-info-modal')" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg text-sm shadow-md transition duration-200">关闭</button>
            </div>
        </div>
    </div>

    <!-- 模态框：通用确认 -->
    <div id="confirm-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 z-[1000] hidden justify-center items-center">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm transition duration-300 transform scale-100" role="alertdialog" aria-modal="true" aria-labelledby="confirm-title">
            <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2" id="confirm-title"></h3>
            <p id="confirm-message" class="text-gray-700 mb-6"></p>
            <div class="flex justify-end space-x-3">
                <button type="button" onclick="closeModal('confirm-modal')" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg shadow-md transition duration-200">取消</button>
                <button type="button" id="confirm-action-btn" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-200">确认</button>
            </div>
             <!-- 隐藏字段用于存储参数，保持原有JS逻辑兼容性 -->
            <input type="hidden" id="confirm-param1">
            <input type="hidden" id="confirm-param2">
            <input type="hidden" id="confirm-param3">
            <input type="hidden" id="confirm-type">
        </div>
    </div>
    
    <!-- 模态框：批量操作（待实现） -->
    <div id="batch-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 z-[1000] hidden justify-center items-center">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-lg transition duration-300 transform scale-100">
            <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">批量操作 / 续期</h3>
            <p class="text-gray-500">此功能将在后续的后端开发中实现。</p>
            <div class="mt-6 flex justify-end">
                <button type="button" onclick="closeModal('batch-modal')" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg shadow-md transition duration-200">关闭</button>
            </div>
        </div>
    </div>
    

    <script>
        // --- 全局配置 (由 Flask 填充) ---
        const API_BASE = '/api';
        let currentView = 'dashboard';
        // NEW V1: 使用单独的 CONFIG 对象存储端口，并在 onload 时填充到 DOM
        const FLASK_CONFIG = {
            WSS_HTTP_PORT: "{{ WSS_HTTP_PORT }}",
            WSS_TLS_PORT: "{{ WSS_TLS_PORT }}",
            STUNNEL_PORT: "{{ STUNNEL_PORT }}",
            UDPGW_PORT: "{{ UDPGW_PORT }}",
            INTERNAL_FORWARD_PORT: "{{ INTERNAL_FORWARD_PORT }}",
            PANEL_PORT: "{{ PANEL_PORT }}"
        };

        // --- 辅助工具函数 ---

        function showStatus(message, isSuccess) {
            const statusDiv = document.getElementById('status-message');
            statusDiv.innerHTML = message;
            
            const colorClass = isSuccess 
                ? 'bg-green-100 text-green-800 border-green-400' 
                : 'bg-red-100 text-red-800 border-red-400';
                
            // FIX: Use explicit string concatenation to avoid template literal issues.
            statusDiv.className = colorClass + ' p-4 mb-6 rounded-xl font-semibold shadow-md block border-l-4';
            statusDiv.style.display = 'block';
            setTimeout(() => { statusDiv.style.display = 'none'; }, 5000);
        }

        function openModal(id) {
            document.getElementById(id).style.display = 'flex';
        }

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }

        function logout() {
            window.location.assign('/logout'); 
        }
        
        function formatSpeed(kbps) {
            const rate = parseFloat(kbps);
            if (rate < 1024) return rate.toFixed(1) + ' KB/s';
            const mbps = rate / 1024;
            return mbps.toFixed(2) + ' MB/s';
        }
        
        // NEW V1: 填充端口号到 DOM
        function fillPortNumbers() {
            document.getElementById('wss-http-port').textContent = FLASK_CONFIG.WSS_HTTP_PORT;
            document.getElementById('wss-tls-port').textContent = FLASK_CONFIG.WSS_TLS_PORT;
            document.getElementById('stunnel-port').textContent = FLASK_CONFIG.STUNNEL_PORT;
            document.getElementById('udpgw-port').textContent = FLASK_CONFIG.UDPGW_PORT;
            document.getElementById('panel-port').textContent = FLASK_CONFIG.PANEL_PORT;
        }

        // --- 视图切换逻辑 ---
        
        function switchView(viewId) {
            const views = ['dashboard', 'users', 'settings', 'security', 'live-ips', 'hosts'];
            views.forEach(id => {
                const element = document.getElementById('view-' + id);
                if (element) element.style.display = (id === viewId) ? 'block' : 'none';
                
                // 更新侧边栏链接样式 (Desktop)
                const navLink = document.getElementById('nav-' + id);
                if (navLink) {
                    navLink.classList.remove('bg-indigo-100', 'text-indigo-700', 'text-gray-700', 'hover:bg-gray-100');
                    if (id === viewId) {
                        navLink.classList.add('bg-indigo-100', 'text-indigo-700', 'font-bold'); // 增强选中样式
                        navLink.classList.remove('text-gray-700', 'hover:bg-gray-100');
                    } else {
                        navLink.classList.add('text-gray-700', 'hover:bg-gray-100');
                        navLink.classList.remove('bg-indigo-100', 'text-indigo-700', 'font-bold');
                    }
                }
            });
            currentView = viewId;
            
            // 刷新当前视图的数据
            refreshAllData();
            
            // 特殊视图的初始化
            if (viewId === 'hosts') {
                fetchHosts();
            }
        }
        
        // --- 数据渲染函数 ---
        
        function renderSystemStatus(data) {
            const grid = document.getElementById('system-status-grid');
            grid.innerHTML = ''; 

            const items = [
                { name: 'CPU 使用率', value: data.cpu_usage.toFixed(1) + '%', color: 'border-blue-500', icon: '⚡' },
                { name: '内存 (用/总)', value: data.memory_used_gb.toFixed(2) + '/' + data.memory_total_gb.toFixed(2) + 'GB', color: 'border-indigo-500', icon: '🧠' },
                { name: '磁盘使用率', value: data.disk_used_percent.toFixed(1) + '%', color: 'border-purple-500', icon: '💾' },
                ...Object.keys(data.services).map(key => {
                    const status = data.services[key].status;
                    let color, dotClass;
                    if (status === 'running') {
                        color = 'border-green-500';
                        dotClass = 'status-active';
                    } else if (status === 'failed') {
                        color = 'border-red-500';
                        dotClass = 'status-expired';
                    } else {
                        color = 'border-yellow-500';
                        dotClass = 'status-paused';
                    }

                    return {
                        name: data.services[key].name,
                        value: data.services[key].label,
                        color: color,
                        dotClass: dotClass,
                        icon: '📡'
                    };
                })
            ];

            // 使用 documentFragment 优化 DOM 写入性能
            const fragment = document.createDocumentFragment();
            items.forEach(item => {
                const dot = item.dotClass ? '<span class="status-dot ' + item.dotClass + '"></span>' : '';
                const card = document.createElement('div');
                card.className = 'bg-white p-4 rounded-xl shadow-md border-b-4 ' + item.color + ' transition duration-300 ease-in-out hover:-translate-y-0.5 hover:shadow-xl';
                card.innerHTML = 
                    '<div class="flex items-center text-sm font-medium text-gray-500 mb-1">' +
                        item.icon + ' <span class="ml-1">' + item.name + '</span>' +
                    '</div>' +
                    '<p class="text-xl font-bold text-gray-800 flex items-center">' +
                        dot + ' ' + item.value +
                    '</p>';
                fragment.appendChild(card);
            });
            grid.innerHTML = ''; // 清空原始内容
            grid.appendChild(fragment);
            
            renderPortStatusList(data.ports);
            renderUserQuickStats(data.user_stats);
        }
        
        function renderPortStatusList(ports) {
            const container = document.getElementById('port-status-data');
            container.innerHTML = '';
            
            const fragment = document.createDocumentFragment();
            ports.forEach(p => {
                const isListening = p.status === 'LISTEN';
                const dotClass = isListening ? 'status-active' : 'status-expired';
                const textClass = isListening ? 'text-green-600' : 'text-red-600';
                
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center text-gray-700 p-2 bg-white rounded-lg shadow-sm border border-gray-100';
                div.innerHTML = 
                    '<span class="font-medium">' + p.name + ' (' + p.port + '/' + p.protocol + '):</span>' +
                    '<span class="font-bold flex items-center ' + textClass + '">' +
                        '<span class="status-dot ' + dotClass + '"></span> ' + p.status +
                    '</span>';
                fragment.appendChild(div);
            });
             container.appendChild(fragment);
        }
        
        function renderUserQuickStats(stats) {
            const container = document.getElementById('user-quick-stats');
            container.innerHTML = 
                '<div class="bg-white p-4 rounded-xl shadow-md border-l-4 border-indigo-500 transition duration-300 ease-in-out hover:-translate-y-0.5 hover:shadow-xl">' +
                    '<p class="text-sm text-gray-500">用户总数</p>' +
                    '<p class="text-2xl font-bold">' + stats.total + '</p>' +
                '</div>' +
                '<div class="bg-white p-4 rounded-xl shadow-md border-l-4 border-green-500 transition duration-300 ease-in-out hover:-translate-y-0.5 hover:shadow-xl">' +
                    '<p class="text-sm text-gray-500">活跃用户</p>' +
                    '<p class="text-2xl font-bold">' + stats.active + '</p>' +
                '</div>' +
                '<div class="bg-white p-4 rounded-xl shadow-md border-l-4 border-yellow-500 transition duration-300 ease-in-out hover:-translate-y-0.5 hover:shadow-xl">' +
                    '<p class="text-sm text-gray-500">暂停/不可用</p>' +
                    '<p class="text-2xl font-bold">' + (stats.paused + stats.expired) + '</p>' +
                '</div>' +
                '<div class="bg-white p-4 rounded-xl shadow-md border-l-4 border-purple-500 transition duration-300 ease-in-out hover:-translate-y-0.5 hover:shadow-xl">' +
                    '<p class="text-sm text-gray-500">总用量</p>' +
                    '<p class="text-2xl font-bold">' + stats.total_traffic_gb.toFixed(2) + ' GB</p>' +
                '</div>';
        }


        function renderUserList(users) {
            const tbody = document.getElementById('user-list-tbody');
            // 使用数组进行字符串拼接，优化性能
            let htmlContent = [];
            
            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="px-6 py-4 text-center text-gray-500">暂无用户账号</td></tr>';
                return;
            }

            users.forEach(user => {
                const isLocked = user.status !== 'active';
                let statusColor = 'bg-green-100 text-green-700';
                if (user.status === 'paused') { statusColor = 'bg-yellow-100 text-yellow-700'; }
                if (user.status === 'expired' || user.status === 'exceeded') { statusColor = 'bg-red-100 text-red-700'; }

                const statusText = user.status_text;
                const toggleAction = isLocked ? 'enable' : 'pause';
                const toggleText = isLocked ? '启用' : '暂停';
                const toggleColor = isLocked ? 'bg-green-500 hover:bg-green-600' : 'bg-yellow-500 hover:bg-yellow-600';
                
                const quotaLimit = user.quota_gb > 0 ? user.quota_gb : '∞';
                // FIX V9: 修正前端显示精度为 toFixed(4)
                const usageText = user.usage_gb.toFixed(4) + ' / ' + quotaLimit + ' GB';
                
                htmlContent.push(`
                    <tr id="row-${user.username}" class="hover:bg-gray-50 transition duration-100">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-mono text-gray-900" role="cell">${user.username}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm" role="cell">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusColor}">
                                ${statusText}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" role="cell">${user.expiration_date || '永不'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-indigo-600" role="cell">${user.active_connections}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-700" role="cell">${usageText}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-mono text-indigo-600" role="cell">${formatSpeed(user.realtime_speed)}</td>
                        <td class="px-6 py-4 text-sm font-medium" role="cell">
                            <div class="flex flex-wrap gap-1">
                                <button onclick="openSessionInfoModal('${user.username}')" 
                                        class="bg-blue-500 hover:bg-blue-600 text-white py-1.5 px-2 rounded-lg text-xs transition duration-150 shadow-sm" aria-label="会话追踪 ${user.username}">会话追踪</button>
                                <button onclick="openSettingsModal('${user.username}', '${user.expiration_date || ''}', ${user.quota_gb}, '${user.rate_kbps}')" 
                                        class="bg-indigo-500 hover:bg-indigo-600 text-white py-1.5 px-2 rounded-lg text-xs transition duration-150 shadow-sm" aria-label="设置 ${user.username}">设置</button>
                                <button onclick="confirmAction('${user.username}', '${toggleAction}', null, 'toggleStatus', '${toggleText}用户')" 
                                        class="${toggleColor} text-white py-1.5 px-2 rounded-lg text-xs transition duration-150 shadow-sm" aria-label="${toggleText}用户 ${user.username}">${toggleText}</button>
                                <button onclick="confirmAction('${user.username}', 'delete', null, 'deleteUser', '删除用户')" 
                                        class="bg-red-500 hover:bg-red-600 text-white py-1.5 px-2 rounded-lg text-xs transition duration-150 shadow-sm" aria-label="删除用户 ${user.username}">删除</button>
                            </div>
                        </td>
                    </tr>
                `);
            });
            tbody.innerHTML = htmlContent.join('');
        }
        
        function renderActiveGlobalIPs(ipData) {
            const container = document.getElementById('live-ip-list');
            let htmlContent = '';
            
            if (ipData.length === 0) {
                container.innerHTML = '<p class="text-gray-500 p-2">目前没有活跃的外部连接。</p>';
                return;
            }

            ipData.forEach(ipInfo => {
                const isBanned = ipInfo.is_banned;
                const action = isBanned ? 'unban' : 'ban';
                const actionText = isBanned ? '已封禁 - 解除' : '全局封禁';
                const buttonColor = isBanned ? 'bg-green-600 hover:bg-green-700' : 'bg-red-600 hover:bg-red-700';
                const banTag = isBanned ? '<span class="text-xs px-2 py-0.5 rounded-full ip-banned-tag ml-2">已封禁 (防火墙)</span>' : '';

                htmlContent += `
                    <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between p-3 bg-white border border-gray-200 rounded-lg shadow-sm">
                        <div class="min-w-0 flex-1 flex flex-col sm:flex-row sm:items-center">
                            <p class="font-mono text-sm text-gray-900 flex items-center">
                                <strong>${ipInfo.ip}</strong> ${banTag}
                            </p>
                        </div>
                        <button onclick="confirmAction(null, '${ipInfo.ip}', null, '${action}Global', '${isBanned ? '解除全局封禁' : '全局封禁 IP'}')" 
                                     class="mt-2 sm:mt-0 w-full sm:w-auto ${buttonColor} text-white py-1.5 px-3 rounded-lg text-xs font-semibold flex-shrink-0">
                            ${actionText}
                        </button>
                    </div>`;
            });
            container.innerHTML = htmlContent;
        }
        
        function renderAuditLogs(logs) {
            const logContainer = document.getElementById('audit-log-content');
            
            // FIX P8: 确保只在日志不为空时进行解析，并处理 tail 返回的空行
            const filteredLogs = logs.filter(log => log.trim() !== "" && log !== '读取日志失败或日志文件为空。' && log !== '日志文件不存在。');

            if (filteredLogs.length === 0) {
                logContainer.innerHTML = '<p class="text-gray-500">目前没有管理员审计活动日志。</p>';
                return;
            }
            
            // 清理旧内容
            logContainer.innerHTML = '';
            const fragment = document.createDocumentFragment();

            filteredLogs.forEach(log => {
                // 正则表达式匹配日志格式: [TIMESTAMP] [USER:...] [IP:...] ACTION:... DETAILS: ...
                const parts = log.match(/^\[(.*?)\] \[USER:(.*?)\] \[IP:(.*?)\] ACTION:(.*?) DETAILS: (.*)$/);
                
                const div = document.createElement('div');
                
                if (parts) {
                    const [_, timestamp, user, ip, action, details] = parts;
                    
                    const safeDetails = document.createElement('div');
                    safeDetails.textContent = details;
                    
                    div.className = 'text-xs text-gray-700 font-mono space-y-1 p-1 hover:bg-gray-200 rounded-md';
                    div.innerHTML = 
                        '<span class="text-indigo-600">' + timestamp.split(' ')[1] + '</span> ' +
                        '<span class="font-bold">[' + user + ']</span> ' +
                        '<span class="text-sm font-semibold text-gray-900">' + action + '</span> ' +
                        '<span class="text-gray-500">' + safeDetails.innerHTML + '</span>'; 
                } else {
                    // 如果格式不匹配，直接显示原始日志（已通过 textContent 保护）
                    div.className = 'text-xs text-gray-700 font-mono p-1';
                    div.textContent = log;
                }
                fragment.appendChild(div);
            });
            logContainer.appendChild(fragment);
        }
        
        function renderGlobalBans(bans) {
            const container = document.getElementById('global-ban-list');
            if (Object.keys(bans).length === 0) {
                container.innerHTML = '<p class="text-green-600 font-semibold p-2">目前没有全局封禁的 IP。</p>';
                return;
            }
            container.innerHTML = Object.keys(bans).map(ip => {
                const banInfo = bans[ip];
                return (
                    '<div class="flex justify-between items-center p-3 bg-red-50 border border-red-200 rounded-lg shadow-sm">' +
                        '<div class="font-mono text-sm text-red-700">' +
                            '<strong>' + ip + '</strong> ' +
                            '<span class="text-xs text-gray-500 ml-4">原因: ' + (banInfo.reason || 'N/A') + ' (添加于 ' + banInfo.timestamp + ')</span>' +
                        '</div>' +
                        '<button onclick="confirmAction(null, \'' + ip + '\', null, \'unbanGlobal\', \'解除全局封禁\')" ' +
                                     'class="bg-green-600 hover:bg-green-700 text-white py-1.5 px-3 rounded-lg text-xs font-semibold flex-shrink-0">解除封禁</button>' +
                    '</div>'
                );
            }).join('');
        }
        
        // NEW HOST FUNCTION: 渲染 Host 列表到 textarea
        function renderHosts(hosts) {
            const textarea = document.getElementById('host-list-textarea');
            const countInfo = document.getElementById('host-count-info');
            
            // 将数组转换为换行符分隔的字符串
            textarea.value = hosts.join('\n');
            
            // 更新计数信息
            const validHosts = hosts.filter(h => h.trim() !== '');
            countInfo.textContent = `当前加载 ${validHosts.length} 个 Host。`;
        }
        
        function renderSessionInfo(username, sessionInfo) {
            const title = document.getElementById('session-modal-username-title');
            title.textContent = username;
            
            // 重新渲染模态框内容，确保不显示 PID
            document.getElementById('session-info-content').innerHTML = `
                <div class="text-sm text-gray-600 pt-2">
                    <p class="font-bold">关联的外部连接 IP (ESTAB):</p>
                    <!-- IP 列表容器 (保留 ID for rendering) -->
                    <div id="session-ips" class="space-y-1 mt-2"></div>
                </div>
            `;
            const ipsDiv = document.getElementById('session-ips');

            // 尽管后端返回了 PID，但我们不显示它，只显示 IP 列表。
            if (sessionInfo.active_ips.length === 0) {
                 ipsDiv.innerHTML = '<p class="text-red-600 font-semibold">未检测到关联的外部 ESTAB IP。</p>'; 
            } else {
                ipsDiv.innerHTML = sessionInfo.active_ips.map(ipInfo => {
                    const isBanned = ipInfo.is_banned;
                    const action = isBanned ? 'unban' : 'ban';
                    const actionText = isBanned ? '解除封禁' : '全局封禁';
                    const buttonColor = isBanned ? 'bg-green-600 hover:bg-green-700' : 'bg-red-600 hover:bg-red-700';
                    const banTag = isBanned ? '<span class="text-xs px-2 py-0.5 rounded-full ip-banned-tag ml-2">已封禁</span>' : '';

                    return '<div class="flex justify-between items-center p-2 bg-white border border-gray-200 rounded-lg shadow-sm text-xs">' +
                               '<p class="font-mono text-gray-900 flex items-center"><strong>' + ipInfo.ip + '</strong> ' + banTag + '</p>' +
                               // FIX: Global Ban button logic uses correct parameters
                               '<button onclick="confirmAction(null, \'' + ipInfo.ip + '\', null, \'' + action + 'Global\', \'' + (isBanned ? '解除全局封禁' : '全局封禁 IP') + '\')" ' +
                               'class="mt-0 w-auto ' + buttonColor + ' text-white py-1 px-2 rounded-lg text-xs font-semibold flex-shrink-0">' +
                               actionText +
                               '</button>' +
                               '</div>';
                }).join('');
            }
        }

        // --- 核心 API 调用函数 ---
        
        async function fetchData(url, options = {}) {
            try {
                const response = await fetch(API_BASE + url, options);
                
                // FIX P7: 检查 401 状态码，如果返回 401 则明确处理，防止解析 HTML
                if (response.status === 401) {
                    showStatus("会话过期或权限不足，请重新登录。", false);
                    window.location.assign('/login');
                    return null;
                }
                
                // Check for redirection (e.g., to /login)
                if (response.redirected) {
                    window.location.assign(response.url);
                    return null;
                }
                
                // **核心修复：** 检查 Content-Type，如果不是 JSON 且请求是成功的（但不是重定向），则可能是 HTML 错误
                const contentType = response.headers.get("content-type");

                if (!contentType || !contentType.includes("application/json")) {
                    if (response.ok) {
                        const text = await response.text();
                        console.error("API expected JSON but got HTML/Text:", text);
                        showStatus("API 响应格式错误，可能返回了 HTML 页面。", false);
                        return null;
                    }
                }
                
                const data = await response.json();
                
                if (!response.ok || !data.success) {
                    showStatus(data.message || 'API Error: ' + url, false);
                    return null;
                }
                return data;
            } catch (error) {
                showStatus('网络请求失败: ' + error.message, false);
                // 捕获到 Unexpected token '<' 的错误会在这里被报告
                return null;
            }
        }

        async function fetchServiceLogs(serviceId) {
            const logContainer = document.getElementById('service-log-content');
            logContainer.textContent = '正在加载 ' + serviceId + ' 日志...';
            
            const data = await fetchData('/system/logs', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ service: serviceId })
            });

            if (data && data.logs) {
                logContainer.textContent = data.logs;
            } else {
                logContainer.textContent = '无法加载 ' + serviceId + ' 日志。';
            }
        }
        
        async function fetchSessionInfo(username) {
            const data = await fetchData('/users/ip_activity?username=' + username);
            if (data && data.session_info) {
                 renderSessionInfo(username, data.session_info);
            } else {
                 renderSessionInfo(username, { sshd_pids: ['N/A'], active_ips: [] }); 
            }
        }
        
        // NEW HOST FUNCTION: 获取 Host 列表
        async function fetchHosts() {
             const data = await fetchData('/settings/hosts');
             if (data && data.hosts) {
                renderHosts(data.hosts);
             } else {
                renderHosts([]);
             }
        }

        // NEW HOST FUNCTION: 保存 Host 列表
        async function saveHosts() {
            const textarea = document.getElementById('host-list-textarea');
            // 将 textarea 内容按行分割，并过滤空行
            const hostsArray = textarea.value.split('\n').map(h => h.trim()).filter(h => h.length > 0);
            
            showStatus('正在保存 Host 配置并重启 WSS 代理...', true);
            
            const result = await fetchData('/settings/hosts', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ hosts: hostsArray })
            });

            if (result) {
                showStatus(result.message, true);
                fetchHosts(); // 重新加载列表
            }
        }

        // --- 实时刷新主函数 ---

        async function refreshAllData() {
            // 1. 获取系统和组件状态
            const statusData = await fetchData('/system/status');
            if (statusData) {
                renderSystemStatus(statusData);
            }

            if (currentView === 'users' || currentView === 'dashboard') {
                // 2. 获取用户列表和统计
                const usersData = await fetchData('/users/list');
                if (usersData) {
                    renderUserList(usersData.users);
                }
            }
            
            if (currentView === 'live-ips') {
                 // 3. 获取实时连接 IP
                 const ipData = await fetchData('/system/active_ips');
                 if (ipData) {
                    renderActiveGlobalIPs(ipData.active_ips);
                 }
            }
            
            if (currentView === 'settings') {
                // 4. 获取审计日志
                // FIX P8: 确保调用正确的 API 路径
                const auditData = await fetchData('/system/audit_logs');
                if (auditData) {
                    renderAuditLogs(auditData.logs);
                }
            }
            
            if (currentView === 'security') {
                // 5. 获取全局 IP 封禁列表
                const globalData = await fetchData('/ips/global_list');
                if (globalData) {
                    renderGlobalBans(globalData.global_bans);
                }
            }
            
            if (currentView === 'hosts') {
                 // 6. 刷新 Host 列表
                 fetchHosts();
            }
            
            // 7. 实时刷新会话模态框
            const sessionModal = document.getElementById('session-info-modal');
            if (sessionModal && sessionModal.style.display === 'flex') {
                const usernameTitle = document.getElementById('session-modal-username-title');
                if (usernameTitle) {
                    const username = usernameTitle.textContent;
                    // 仅在模态框打开时刷新会话信息
                    const data = await fetchData('/users/ip_activity?username=' + username);
                    if (data && data.session_info) {
                        renderSessionInfo(username, data.session_info);
                    }
                }
            }
        }

        // --- 用户操作实现 ---

        document.getElementById('add-user-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const username = document.getElementById('new-username').value;
            const password = document.getElementById('new-password').value;
            const expirationDays = document.getElementById('expiration-days').value;
            const quotaGb = document.getElementById('quota-gb').value;
            const rateKbps = document.getElementById('rate-kbps').value;

            if (!/^[a-z0-9_]{3,16}$/.test(username)) {
                showStatus('用户名格式不正确 (3-16位小写字母/数字/下划线)', false);
                return;
            }
            
            showStatus('正在创建用户 ' + username + '...', true);

            const result = await fetchData('/users/add', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    username: username, 
                    password: password, 
                    expiration_days: parseInt(expirationDays),
                    quota_gb: parseFloat(quotaGb),
                    rate_kbps: parseInt(rateKbps)
                })
            });

            if (result) {
                showStatus(result.message, true);
                document.getElementById('add-user-form').reset();
                refreshAllData(); 
            }
        });
        
        function openSettingsModal(username, expiry_date, quota_gb, rate_kbps) {
            document.getElementById('modal-username-title-settings').textContent = username; // Note the updated ID
            document.getElementById('modal-username-setting').value = username;
            
            document.getElementById('modal-expiry-date').value = expiry_date; 
            document.getElementById('modal-quota-gb').value = quota_gb;
            document.getElementById('modal-rate-kbps').value = rate_kbps;
            document.getElementById('modal-new-password').value = '';
            
            openModal('settings-modal');
        }
        
        // FIX: openSessionInfoModal logic simplified to rely on fetchSessionInfo to open modal
        function openSessionInfoModal(username) {
            document.getElementById('session-modal-username-title').textContent = username;
            
            // Set loading state with new structure
            document.getElementById('session-info-content').innerHTML = `
                <div class="text-sm text-gray-600 pt-2">
                    <p class="font-bold">关联的外部连接 IP (ESTAB):</p>
                    <div id="session-ips" class="space-y-1 mt-2">正在加载 IP 信息...</div>
                </div>
            `;
            
            openModal('session-info-modal'); 
            fetchSessionInfo(username); // Start fetching data
        }

        async function saveUserSettings() {
            const username = document.getElementById('modal-username-setting').value;
            const expiry_date = document.getElementById('modal-expiry-date').value;
            const quota_gb = document.getElementById('modal-quota-gb').value;
            const rate_kbps = document.getElementById('modal-rate-kbps').value;
            const new_password = document.getElementById('modal-new-password').value;
            
            closeModal('settings-modal');
            showStatus('正在保存用户 ' + username + ' 的设置...', true);

            const result = await fetchData('/users/set_settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    username: username, 
                    expiry_date: expiry_date, 
                    quota_gb: parseFloat(quota_gb), 
                    rate_kbps: parseInt(rate_kbps),
                    new_ssh_password: new_password
                })
            });

            if (result) {
                showStatus(result.message, true);
                refreshAllData();
            }
        }
        
        // --- 通用确认及执行逻辑 ---

        function confirmAction(param1, param2, param3, type, titleText) {
            let message = '';
            
            document.getElementById('confirm-param1').value = param1 || ''; // username, service, or null
            document.getElementById('confirm-param2').value = param2 || ''; // action, IP, or null
            document.getElementById('confirm-param3').value = param3 || ''; // extra param (unused)
            document.getElementById('confirm-type').value = type;
            
            const username = param1;
            const action = param2; // IP or action name
            
            if (type === 'deleteUser') {
                message = '您确定要永久删除用户 <strong>' + username + '</strong> 吗？此操作不可逆，将删除系统账户和所有配置。';
            } else if (type === 'toggleStatus') {
                message = '您确定要 ' + (action === 'pause' ? '暂停' : '启用') + ' 用户 <strong>' + username + '</strong> 吗？';
            } else if (type === 'serviceControl') {
                message = '警告：您确定要重启核心服务 <strong>' + username + '</strong> 吗？这可能会导致短暂的服务中断。';
            } else if (type === 'unbanGlobal') {
                message = '您确定要解除全局封禁 IP 地址 <strong>' + action + '</strong> 吗？';
                closeModal('session-info-modal'); // 如果从会话模态框发起操作，先关闭它
            } else if (type === 'banGlobal') {
                message = '您确定要对 IP 地址 <strong>' + action + '</strong> 执行全局封禁操作吗？';
                closeModal('session-info-modal'); // 如果从会话模态框发起操作，先关闭它
            } else if (type === 'resetTraffic') {
                message = '警告：您确定要将用户 <strong>' + username + '</strong> 的流量使用量计数器重置为 0 吗？';
            } else if (type === 'killAll') {
                message = '警告：您确定要强制断开用户 <strong>' + username + '</strong> 的所有活跃连接吗？这会强制用户重新连接。';
                closeModal('session-info-modal');
            }

            document.getElementById('confirm-title').textContent = titleText;
            document.getElementById('confirm-message').innerHTML = message;
            
            const confirmBtn = document.getElementById('confirm-action-btn');
            
            if (type.includes('ban') || type === 'deleteUser' || type === 'serviceControl' || type === 'killAll') {
                 confirmBtn.className = 'bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-200';
            } else if (type.includes('enable') || type === 'unbanGlobal' || type === 'resetTraffic') {
                 confirmBtn.className = 'bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-200';
            } else {
                 confirmBtn.className = 'bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-200';
            }

            confirmBtn.onclick = executeAction;
            
            openModal('confirm-modal');
        }

        async function executeAction() {
            closeModal('confirm-modal');
            
            // 从隐藏字段读取参数
            const param1 = document.getElementById('confirm-param1').value;
            const param2 = document.getElementById('confirm-param2').value;
            const type = document.getElementById('confirm-type').value;

            showStatus('正在执行 ' + type + ' 操作...', true);

            let url;
            let body = {};

            if (type === 'deleteUser') {
                url = '/users/delete';
                body = { username: param1 };
            } else if (type === 'toggleStatus') {
                url = '/users/status';
                body = { username: param1, action: param2 }; // param2 is action (enable/pause)
            } else if (type === 'resetTraffic') {
                url = '/users/reset_traffic';
                body = { username: param1 };
            } else if (type === 'serviceControl') {
                url = '/system/control';
                body = { service: param1, action: param2 }; // param1: service, param2: action
            } else if (type === 'unbanGlobal') {
                url = '/ips/unban_global';
                body = { ip: param2 }; // param2: IP
            } else if (type === 'banGlobal') {
                url = '/ips/ban_global';
                body = { ip: param2, reason: 'Manual Global Ban' }; // param2: IP
            } else if (type === 'killAll') {
                url = '/users/kill_all';
                body = { username: param1 };
            }

            const result = await fetchData(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });

            if (result) {
                showStatus(result.message, true);
                
                // 系统控制或主用户列表的刷新 (延迟刷新以等待系统命令生效)
                if (type === 'serviceControl' || type === 'deleteUser' || type === 'toggleStatus' || type === 'unbanGlobal' || type === 'banGlobal' || type === 'resetTraffic' || type === 'killAll') {
                    setTimeout(refreshAllData, 2000); 
                }
            }
        }
        
        document.getElementById('add-global-ban-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const ip = document.getElementById('global-ban-ip').value;
            
            if (!ip) return showStatus('IP 地址不能为空', false);
            
            confirmAction(null, ip, null, 'banGlobal', '全局封禁 IP');
        });


        // --- 启动脚本 ---
        
        window.onload = function() {
            // NEW V1: 填充端口号
            fillPortNumbers();
            
            // 确保默认选中状态正确应用
            const defaultNav = document.getElementById('nav-dashboard');
            if (defaultNav) {
                defaultNav.classList.add('bg-indigo-100', 'text-indigo-700', 'font-bold');
                defaultNav.classList.remove('text-gray-700', 'hover:bg-gray-100');
            }

            // 确保移动端下拉框选中正确的初始值
            const mobileSelect = document.getElementById('mobile-view-select');
            if (mobileSelect) {
                mobileSelect.value = 'dashboard';
            }

            switchView('dashboard');
            setInterval(refreshAllData, 10000); 
        };

    </script>
</body>
</html>
