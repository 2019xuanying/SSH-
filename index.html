<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WSS éš§é“ç®¡ç†é¢æ¿ - V2.3 ç§»åŠ¨ä¼˜åŒ–ç‰ˆ</title>
    <!-- å¼•å…¥ Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ä¿æŒå­—ä½“å¼•å…¥ï¼Œä½¿ç”¨ Inter */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        
        /* ä»…ä¿ç•™åŠŸèƒ½æ€§/ä¸å¯æ›¿ä»£çš„æ ·å¼ */
        .log-pre { font-family: monospace; font-size: 0.8rem; white-space: pre; overflow-x: auto; max-height: 200px; }
        .status-dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 6px; }
        .status-active { background-color: #10b981; } /* Tailwind: green-500 */
        .status-paused { background-color: #f59e0b; } /* Tailwind: amber-500 */
        .status-expired { background-color: #ef4444; } /* Tailwind: red-500 */
        .ip-banned-tag { background-color: #fca5a5; color: #dc2626; font-weight: 600; } /* Tailwind: red-300 / red-700 */

        /* ä¼˜åŒ–ä¸»å¸ƒå±€ï¼šä½¿ç”¨ calc(100vh - header_height) ç¡®ä¿å†…å®¹åŒºåŸŸæ»šåŠ¨ */
        .main-content-area {
            min-height: calc(100vh - 72px); /* 72px is the header height (py-4 + text-size) */
        }
        
        .card { transition: all 0.3s ease; }
        .card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px rgba(0,0,0,0.05); }
        .modal { position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.5); z-index: 1000; display: none; justify-content: center; align-items: center; }
        .modal > div { max-width: 90%; }
        
        /* å¼ºåˆ¶éšè—æ•°å­—è¾“å…¥æ¡†çš„é»˜è®¤ç®­å¤´ï¼Œæé«˜ç¾è§‚åº¦ */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
          -webkit-appearance: none; 
          margin: 0; 
        }
        input[type=number] {
            -moz-appearance: textfield;
        }

    </style>
</head>
<body>

    <!-- Header / å¯¼èˆªæ  -->
    <header class="bg-indigo-700 shadow-lg sticky top-0 z-20">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-white tracking-wide">WSS éš§é“ç®¡ç†é¢æ¿ (V2.3 ä¼˜åŒ–ç‰ˆ)</h1>
            <button onclick="logout()" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 shadow-md">
                é€€å‡ºç™»å½•
            </button>
        </div>
    </header>

    <!-- ä¸»å¸ƒå±€ï¼šä¾§è¾¹æ  + å†…å®¹åŒº -->
    <div class="main-content-area max-w-7xl mx-auto flex">
        <!-- ä¾§è¾¹æ  (w-64, sticky) -->
        <aside class="w-64 bg-white shadow-xl flex-shrink-0 sticky top-[72px] h-[calc(100vh-72px)] overflow-y-auto hidden md:block border-r border-gray-100">
            <nav class="p-4 space-y-2">
                <!-- å¯¼èˆªé“¾æ¥ï¼šä½¿ç”¨ ID è¿›è¡Œ JS åˆ‡æ¢ -->
                <a onclick="switchView('dashboard')" class="nav-link block p-3 rounded-xl cursor-pointer text-indigo-700 font-semibold bg-indigo-100 hover:bg-indigo-200 transition duration-150" id="nav-dashboard">
                    ğŸ“Š ä»ªè¡¨ç›˜ (Dashboard)
                </a>
                <a onclick="switchView('users')" class="nav-link block p-3 rounded-xl cursor-pointer text-gray-700 font-semibold hover:bg-gray-100 transition duration-150" id="nav-users">
                    ğŸ‘¤ ç”¨æˆ·ç®¡ç†
                </a>
                <a onclick="switchView('live-ips')" class="nav-link block p-3 rounded-xl cursor-pointer text-gray-700 font-semibold hover:bg-gray-100 transition duration-150" id="nav-live-ips">
                    ğŸ“¡ å®æ—¶è¿æ¥ IP
                </a>
                <!-- NEW: Host ç™½åå•å¯¼èˆª -->
                <a onclick="switchView('hosts')" class="nav-link block p-3 rounded-xl cursor-pointer text-gray-700 font-semibold hover:bg-gray-100 transition duration-150" id="nav-hosts">
                    âš™ï¸ Host ç™½åå•
                </a>
                <a onclick="switchView('settings')" class="nav-link block p-3 rounded-xl cursor-pointer text-gray-700 font-semibold hover:bg-gray-100 transition duration-150" id="nav-settings">
                    ğŸ› ï¸ ç³»ç»Ÿé…ç½®/æ—¥å¿—
                </a>
                <a onclick="switchView('security')" class="nav-link block p-3 rounded-xl cursor-pointer text-gray-700 font-semibold hover:bg-gray-100 transition duration-150" id="nav-security">
                    ğŸ”’ å…¨å±€ IP å°ç¦åˆ—è¡¨
                </a>
            </nav>
        </aside>

        <!-- å†…å®¹åŒºåŸŸ -->
        <main class="flex-grow p-4 sm:p-6 lg:p-8">
            
            <!-- ç§»åŠ¨ç«¯å¯¼èˆªé€‰æ‹©å™¨ (æ–°å¢å“åº”å¼ç»„ä»¶) -->
            <div class="block md:hidden mb-6">
                <label for="mobile-view-select" class="sr-only">é€‰æ‹©è§†å›¾</label>
                <select id="mobile-view-select" onchange="switchView(this.value)" class="w-full p-3 border border-gray-300 rounded-lg bg-white text-gray-700 font-semibold focus:ring-indigo-500 focus:border-indigo-500 shadow-sm">
                    <option value="dashboard">ğŸ“Š ä»ªè¡¨ç›˜ (Dashboard)</option>
                    <option value="users">ğŸ‘¤ ç”¨æˆ·ç®¡ç†</option>
                    <option value="live-ips">ğŸ“¡ å®æ—¶è¿æ¥ IP</option>
                    <option value="hosts">âš™ï¸ Host ç™½åå•</option>
                    <option value="settings">ğŸ› ï¸ ç³»ç»Ÿé…ç½®/æ—¥å¿—</option>
                    <option value="security">ğŸ”’ å…¨å±€ IP å°ç¦åˆ—è¡¨</option>
                </select>
            </div>
            
            <!-- å…¨å±€çŠ¶æ€ä¿¡æ¯/è­¦å‘Š -->
            <div id="status-message" class="hidden p-4 mb-6 rounded-xl font-medium border-l-4" role="alert"></div>

            <!-- 1. ä»ªè¡¨ç›˜è§†å›¾ (é»˜è®¤æ˜¾ç¤º) -->
            <div id="view-dashboard" >
                <!-- å®æ—¶ç³»ç»ŸçŠ¶æ€å¡ç‰‡ -->
                <section class="mb-8">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4">æ ¸å¿ƒåŸºç¡€è®¾æ–½çŠ¶æ€</h2>
                    <div id="system-status-grid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
                        <!-- åŠ¨æ€åŠ è½½ç³»ç»Ÿå’Œç»„ä»¶çŠ¶æ€ -->
                        <p class="text-gray-500 col-span-full">æ­£åœ¨åŠ è½½ç³»ç»ŸçŠ¶æ€...</p>
                    </div>
                </section>
                
                <!-- ç«¯å£çŠ¶æ€å’Œæ ¸å¿ƒæ“ä½œ -->
                <section class="card bg-white p-6 rounded-xl shadow-lg mb-8">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">æœåŠ¡ç«¯å£ä¸æ§åˆ¶</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div id="port-status-data" class="md:col-span-1 p-4 bg-gray-50 rounded-lg space-y-2 text-sm border">
                            <!-- ç«¯å£åˆ—è¡¨ï¼ˆåŠ¨æ€åŠ è½½ï¼‰ -->
                            <p class="text-gray-500">æ­£åœ¨æ£€æŸ¥ç«¯å£çŠ¶æ€...</p>
                        </div>
                        <!-- æœåŠ¡æ§åˆ¶æŒ‰é’®ï¼šåœ¨å°å±å¹•ä¸Šï¼ŒæŒ‰é’®ä¼šé€šè¿‡ space-y-3 å‚ç›´å †å  -->
                        <div class="md:col-span-2 space-y-3">
                            <!-- NOTE: ä½¿ç”¨ JS åŠ¨æ€è·å–ç«¯å£ï¼Œè€Œä¸æ˜¯ Flask æ¸²æŸ“ -->
                            <button onclick="confirmAction('wss', 'restart', null, 'serviceControl', 'é‡å¯ WSS')" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition duration-200 shadow-md">
                                é‡å¯ WSS Proxy (<span id="wss-http-port"></span>/<span id="wss-tls-port"></span>)
                            </button>
                            <button onclick="confirmAction('stunnel4', 'restart', null, 'serviceControl', 'é‡å¯ Stunnel4')" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition duration-200 shadow-md">
                                é‡å¯ Stunnel4 (<span id="stunnel-port"></span>)
                            </button>
                            <button onclick="confirmAction('udpgw', 'restart', null, 'serviceControl', 'é‡å¯ UDPGW')" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition duration-200 shadow-md">
                                é‡å¯ UDPGW (<span id="udpgw-port"></span>)
                            </button>
                            <button onclick="confirmAction('wss_panel', 'restart', null, 'serviceControl', 'é‡å¯é¢æ¿')" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-lg transition duration-200 shadow-md">
                                é‡å¯ Web Panel (<span id="panel-port"></span>)
                            </button>
                        </div>
                    </div>
                </section>
                
                <!-- å¿«é€Ÿç”¨æˆ·ç»Ÿè®¡ï¼ˆå¯ä½œä¸ºä»ªè¡¨ç›˜å¡ç‰‡ï¼‰ -->
                <section class="mb-8">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4">ç”¨æˆ·å¿«é€Ÿç»Ÿè®¡</h2>
                    <div id="user-quick-stats" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
                        <!-- åŠ¨æ€åŠ è½½ç”¨æˆ·æ€»æ•°ã€æ´»è·ƒæ•°ç­‰ -->
                    </div>
                </section>
            </div>

            <!-- 2. ç”¨æˆ·ç®¡ç†è§†å›¾ -->
            <div id="view-users" class="hidden">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">ğŸ‘¤ ç”¨æˆ·ç®¡ç†</h2>
                
                <!-- æ–°å¢ç”¨æˆ·è¡¨å• -->
                <section class="card bg-white p-6 rounded-xl shadow-lg mb-8">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">æ–°å¢ SSH éš§é“ç”¨æˆ·</h3>
                    <!-- ğŸ› ä¿®å¤ï¼šåœ¨å°å±å¹•ä¸Šå¼ºåˆ¶å †å ï¼Œå¹¶æ·»åŠ æ ‡ç­¾ -->
                    <form id="add-user-form" class="grid grid-cols-1 md:grid-cols-6 gap-4 items-end">
                        <div class="md:col-span-2">
                             <label for="new-username" class="block text-sm font-medium text-gray-700 mb-1">ç”¨æˆ·å (Username)</label>
                             <input type="text" id="new-username" placeholder="ç”¨æˆ·å (Username)" required
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div class="md:col-span-2">
                            <label for="new-password" class="block text-sm font-medium text-gray-700 mb-1">å¯†ç  (Password)</label>
                            <input type="password" id="new-password" placeholder="å¯†ç  (Password)" required
                                   class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div class="md:col-span-1">
                             <label for="expiration-days" class="block text-sm font-medium text-gray-700 mb-1">æœ‰æ•ˆæœŸ (å¤©)</label>
                             <input type="number" id="expiration-days" value="365" min="1" placeholder="æœ‰æ•ˆæœŸ (å¤©)" required
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"
                                    aria-label="ç”¨æˆ·æœ‰æ•ˆæœŸï¼Œå•ä½å¤©">
                        </div>
                        
                        <div class="md:col-span-1">
                             <label for="quota-gb" class="block text-sm font-medium text-gray-700 mb-1">é…é¢ (GB, 0=âˆ)</label>
                             <input type="number" id="quota-gb" value="0" min="0" placeholder="é…é¢ (GB, 0=âˆ)" required
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"
                                    aria-label="ç”¨æˆ·æµé‡é…é¢ï¼Œå•ä½GB">
                        </div>
                        
                        <div class="md:col-span-2">
                             <label for="rate-kbps" class="block text-sm font-medium text-gray-700 mb-1">é™é€Ÿ (KB/s, 0=âˆ)</label>
                             <input type="number" id="rate-kbps" value="0" min="0" placeholder="é™é€Ÿ (KB/s, 0=âˆ)" required
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"
                                    aria-label="ç”¨æˆ·æœ€å¤§é€Ÿåº¦ï¼Œå•ä½KB/ç§’">
                        </div>
                        
                        <button type="submit" class="md:col-span-1 bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg transition duration-200 shadow-md">
                            åˆ›å»ºç”¨æˆ·
                        </button>
                        <!-- å ä½ç¬¦ï¼Œä¿æŒå¸ƒå±€ -->
                        <div class="md:col-span-3"></div>
                    </form>
                    <!-- æ‰¹é‡æ“ä½œæŒ‰é’® -->
                    <button onclick="openModal('batch-modal')" class="mt-4 bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-lg transition duration-200 text-sm shadow-md">
                        æ‰¹é‡æ“ä½œ / ç»­æœŸ (å¾…å®ç°)
                    </button>
                </section>
                
                <!-- ç”¨æˆ·åˆ—è¡¨ -->
                <section class="card bg-white p-6 rounded-xl shadow-lg">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">ç°æœ‰ç”¨æˆ·åˆ—è¡¨</h3>
                    <!-- ğŸ› ä¿®å¤ï¼šåœ¨å°å±å¹•ä¸Šå…è®¸æ°´å¹³æ»šåŠ¨ -->
                    <div class="overflow-x-auto border border-gray-200 rounded-lg">
                        <table class="min-w-full divide-y divide-gray-200" role="table">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" role="columnheader">ç”¨æˆ·</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" role="columnheader">çŠ¶æ€</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" role="columnheader">åˆ°æœŸæ—¥</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" role="columnheader">è¿æ¥æ•°</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" role="columnheader">ç”¨é‡/é™é¢ (GB)</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" role="columnheader">é™é€Ÿ (KB/s)</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" role="columnheader">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="user-list-tbody" class="bg-white divide-y divide-gray-200">
                                <!-- åŠ¨æ€åŠ è½½ç”¨æˆ·åˆ—è¡¨ -->
                            </tbody>
                        </table>
                    </div>
                </section>
            </div>
            
            <!-- 3. å®æ—¶è¿æ¥ IP åˆ—è¡¨è§†å›¾ (NEW) -->
            <div id="view-live-ips" class="hidden">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">ğŸ“¡ å®æ—¶è¿æ¥ IP åˆ—è¡¨</h2>
                <section class="card bg-white p-6 rounded-xl shadow-lg">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">å½“å‰è¿æ¥åˆ° WSS/Stunnel ç«¯å£çš„å¤–éƒ¨ IP</h3>
                    <div id="live-ip-list" class="space-y-3 max-h-96 overflow-y-auto p-3 bg-gray-50 rounded-lg border">
                        <p class="text-gray-500">æ­£åœ¨åŠ è½½å®æ—¶ IP æ•°æ®...</p>
                    </div>
                    <p class="text-xs text-gray-500 mt-4">æ­¤åˆ—è¡¨æ˜¾ç¤º TCP ESTABLISHED çŠ¶æ€çš„è¿æ¥ IPã€‚è¯·è°¨æ…ä½¿ç”¨å°ç¦åŠŸèƒ½ã€‚</p>
                </section>
            </div>

            <!-- 4. Host ç™½åå•é…ç½®è§†å›¾ (NEW) -->
            <div id="view-hosts" class="hidden">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">âš™ï¸ WSS ä»£ç† Host ç™½åå•ç®¡ç†</h2>

                <section class="card bg-white p-6 rounded-xl shadow-lg">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">å…æµ Host åˆ—è¡¨é…ç½®</h3>
                    <p class="text-sm text-gray-600 mb-4">WSS ä»£ç†ï¼ˆHttp/Tls ç«¯å£ï¼‰ä»…å…è®¸è¿æ¥æ—¶è¯·æ±‚çš„ Host åœ¨æ­¤åˆ—è¡¨ä¸­çš„æµé‡é€šè¿‡ã€‚ç”¨äºè¿è¥å•†å…æµæˆ–å®šå‘æµé‡è¯†åˆ«ã€‚</p>
                    
                    <form onsubmit="event.preventDefault(); saveHosts();">
                        <textarea id="host-list-textarea" rows="10" placeholder="æ¯è¡Œè¾“å…¥ä¸€ä¸ª Host åŸŸåï¼Œä¾‹å¦‚ï¼š\ncmcc.com\n10086.cn\n..."
                                  class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 font-mono text-sm resize-none"></textarea>
                        
                        <div class="mt-4 flex justify-between items-center">
                            <p id="host-count-info" class="text-sm text-gray-500">å½“å‰åŠ è½½ 0 ä¸ª Hostã€‚</p>
                            <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg transition duration-200 shadow-md flex-shrink-0">
                                ä¿å­˜å¹¶é‡å¯ WSS ä»£ç†
                            </button>
                        </div>
                    </form>
                </section>
            </div>


            <!-- 5. ç³»ç»Ÿé…ç½®/æ—¥å¿—è§†å›¾ (åŸ 3) -->
            <div id="view-settings" class="hidden">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">ğŸ› ï¸ ç³»ç»Ÿé…ç½®/æ—¥å¿—</h2>

                <section class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="card bg-white p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">æ ¸å¿ƒæœåŠ¡æ—¥å¿— (æœ€æ–° 50 è¡Œ)</h3>
                        <div class="space-y-4">
                            <div class="flex space-x-2 flex-wrap">
                                <button onclick="fetchServiceLogs('wss')" class="bg-gray-200 hover:bg-gray-300 px-3 py-1 text-sm rounded-lg mb-2 shadow-sm">WSS Proxy</button>
                                <button onclick="fetchServiceLogs('stunnel4')" class="bg-gray-200 hover:bg-gray-300 px-3 py-1 text-sm rounded-lg mb-2 shadow-sm">Stunnel4</button>
                                <button onclick="fetchServiceLogs('udpgw')" class="bg-gray-200 hover:bg-gray-300 px-3 py-1 text-sm rounded-lg mb-2 shadow-sm">UDPGW</button>
                                <button onclick="fetchServiceLogs('wss_panel')" class="bg-gray-200 hover:bg-gray-300 px-3 py-1 text-sm rounded-lg mb-2 shadow-sm">Web Panel</button>
                            </div>
                            <div class="bg-gray-800 text-gray-200 p-3 rounded-lg overflow-hidden border border-gray-700">
                                <pre id="service-log-content" class="log-pre">è¯·é€‰æ‹©æœåŠ¡åŠ è½½æ—¥å¿—...</pre>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card bg-white p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">ç®¡ç†å‘˜å®¡è®¡æ—¥å¿— (æœ€æ–°æ´»åŠ¨)</h3>
                        <div class="bg-gray-100 p-3 rounded-lg max-h-[300px] overflow-y-auto border">
                             <div id="audit-log-content" class="text-xs text-gray-700 space-y-1">æ­£åœ¨åŠ è½½å®¡è®¡æ—¥å¿—...</div>
                        </div>
                    </div>
                </section>
            </div>
            
            <!-- 6. å®‰å…¨/IP å°ç¦åˆ—è¡¨è§†å›¾ (åŸ 4) -->
            <div id="view-security" class="hidden">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">ğŸ”’ å…¨å±€ IP å°ç¦ç®¡ç†</h2>

                <section class="card bg-white p-6 rounded-xl shadow-lg mb-8">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">IPTables å…¨å±€å°ç¦ IP åˆ—è¡¨</h3>
                    <div id="global-ban-list" class="space-y-3 max-h-96 overflow-y-auto p-3 bg-gray-50 rounded-lg border">
                        <p class="text-gray-500">æ­£åœ¨åŠ è½½å…¨å±€ IP å°ç¦åˆ—è¡¨...</p>
                    </div>
                </section>
                
                <section class="card bg-white p-6 rounded-xl shadow-lg">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">æ–°å¢å…¨å±€å°ç¦ IP</h3>
                    <form id="add-global-ban-form" class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4">
                        <input type="text" id="global-ban-ip" placeholder="è¾“å…¥è¦å°ç¦çš„ IP åœ°å€" required
                                class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500">
                        <button type="submit" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg transition duration-200 shadow-md flex-shrink-0">
                            å…¨å±€å°ç¦
                        </button>
                    </form>
                </section>
            </div>

        </main>
    </div>

    <!-- æ¨¡æ€æ¡†ï¼šè®¾ç½®ç”¨æˆ·é…é¢/é€Ÿåº¦/å¯†ç /æœ‰æ•ˆæœŸ -->
    <div id="settings-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 z-[1000] hidden justify-center items-center">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-lg transition duration-300 transform scale-100">
            <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">è®¾ç½® <span id="modal-username-title-settings" class="text-indigo-600"></span> çš„å‚æ•°</h3>
            <form id="settings-form" onsubmit="event.preventDefault(); saveUserSettings();">
                <input type="hidden" id="modal-username-setting">
                
                <div class="space-y-4">
                    <div>
                        <label for="modal-expiry-date" class="block text-sm font-medium text-gray-700 mb-1">åˆ°æœŸæ—¥æœŸ (YYYY-MM-DD, æ°¸ä¸ç•™ç©º)</label>
                        <input type="date" id="modal-expiry-date" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="modal-quota-gb" class="block text-sm font-medium text-gray-700 mb-1">æµé‡é™é¢ (GB, 0=æ— é™åˆ¶)</label>
                            <input type="number" id="modal-quota-gb" min="0" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div>
                            <label for="modal-rate-kbps" class="block text-sm font-medium text-gray-700 mb-1">æœ€å¤§é€Ÿåº¦ (KB/s, 0=æ— é™åˆ¶)</label>
                            <input type="number" id="modal-rate-kbps" min="0" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                    </div>

                    <div class="border-t pt-4">
                        <label for="modal-new-password" class="block text-sm font-medium text-gray-700 mb-1">ä¿®æ”¹å¯†ç  (é€‰å¡«)</label>
                        <input type="password" id="modal-new-password" placeholder="ç•™ç©ºåˆ™ä¸ä¿®æ”¹" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                        <p class="text-xs text-gray-500 mt-1">æ³¨æ„ï¼šä¿®æ”¹å¯†ç åï¼Œæ‰€æœ‰è¯¥ç”¨æˆ·å½“å‰æ´»è·ƒçš„è¿æ¥å°†è¢«å¼ºåˆ¶æ–­å¼€ã€‚</p>
                    </div>
                </div>

                <div class="mt-6 flex justify-between">
                    <button type="button" onclick="confirmAction(document.getElementById('modal-username-setting').value, null, null, 'resetTraffic', 'é‡ç½®æµé‡')" 
                            class="bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-200">é‡ç½®æµé‡</button>
                    <div class="flex space-x-3">
                        <button type="button" onclick="closeModal('settings-modal')" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg shadow-md transition duration-200">å–æ¶ˆ</button>
                        <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-200">ä¿å­˜è®¾ç½®</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    
    <!-- æ¨¡æ€æ¡†ï¼šSSH æ´»è·ƒä¼šè¯ä¿¡æ¯ (ä¿®æ”¹åçš„ç»“æ„) -->
    <div id="session-info-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 z-[1000] hidden justify-center items-center">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-2xl transition duration-300 transform scale-100">
            <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">ç”¨æˆ· <span id="session-modal-username-title" class="text-indigo-600"></span> æ´»è·ƒ IP</h3>
            
            <div id="session-info-content" class="space-y-4">
                <div class="text-sm text-gray-600 pt-2">
                    <p class="font-bold">å…³è”çš„å¤–éƒ¨è¿æ¥ IP (ESTAB):</p>
                    <!-- IP åˆ—è¡¨å®¹å™¨ (ä¿ç•™ ID for rendering) -->
                    <div id="session-ips" class="space-y-1 mt-2">æ­£åœ¨åŠ è½½ IP ä¿¡æ¯...</div>
                </div>
            </div>
            
            <div class="mt-6 flex justify-between">
                <button onclick="confirmAction(document.getElementById('session-modal-username-title').textContent, null, null, 'killAll', 'å¼ºåˆ¶æ–­å¼€æ‰€æœ‰')" 
                        class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg text-sm shadow-md transition duration-200">
                    å¼ºåˆ¶æ–­å¼€æ‰€æœ‰è¿æ¥
                </button>
                <button type="button" onclick="closeModal('session-info-modal')" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg text-sm shadow-md transition duration-200">å…³é—­</button>
            </div>
        </div>
    </div>

    <!-- æ¨¡æ€æ¡†ï¼šé€šç”¨ç¡®è®¤ -->
    <div id="confirm-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 z-[1000] hidden justify-center items-center">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm transition duration-300 transform scale-100" role="alertdialog" aria-modal="true" aria-labelledby="confirm-title">
            <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2" id="confirm-title"></h3>
            <p id="confirm-message" class="text-gray-700 mb-6"></p>
            <div class="flex justify-end space-x-3">
                <button type="button" onclick="closeModal('confirm-modal')" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg shadow-md transition duration-200">å–æ¶ˆ</button>
                <button type="button" id="confirm-action-btn" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-200">ç¡®è®¤</button>
            </div>
             <!-- éšè—å­—æ®µç”¨äºå­˜å‚¨å‚æ•°ï¼Œä¿æŒåŸæœ‰JSé€»è¾‘å…¼å®¹æ€§ -->
            <input type="hidden" id="confirm-param1">
            <input type="hidden" id="confirm-param2">
            <input type="hidden" id="confirm-param3">
            <input type="hidden" id="confirm-type">
        </div>
    </div>
    
    <!-- æ¨¡æ€æ¡†ï¼šæ‰¹é‡æ“ä½œï¼ˆå¾…å®ç°ï¼‰ -->
    <div id="batch-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 z-[1000] hidden justify-center items-center">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-lg transition duration-300 transform scale-100">
            <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">æ‰¹é‡æ“ä½œ / ç»­æœŸ</h3>
            <p class="text-gray-500">æ­¤åŠŸèƒ½å°†åœ¨åç»­çš„åç«¯å¼€å‘ä¸­å®ç°ã€‚</p>
            <div class="mt-6 flex justify-end">
                <button type="button" onclick="closeModal('batch-modal')" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg shadow-md transition duration-200">å…³é—­</button>
            </div>
        </div>
    </div>
    

    <script>
        // --- å…¨å±€é…ç½® (ç”± Flask å¡«å……) ---
        const API_BASE = '/api';
        let currentView = 'dashboard';
        // NEW V1: ä½¿ç”¨å•ç‹¬çš„ CONFIG å¯¹è±¡å­˜å‚¨ç«¯å£ï¼Œå¹¶åœ¨ onload æ—¶å¡«å……åˆ° DOM
        const FLASK_CONFIG = {
            WSS_HTTP_PORT: "{{ WSS_HTTP_PORT }}",
            WSS_TLS_PORT: "{{ WSS_TLS_PORT }}",
            STUNNEL_PORT: "{{ STUNNEL_PORT }}",
            UDPGW_PORT: "{{ UDPGW_PORT }}",
            INTERNAL_FORWARD_PORT: "{{ INTERNAL_FORWARD_PORT }}",
            PANEL_PORT: "{{ PANEL_PORT }}"
        };

        // --- è¾…åŠ©å·¥å…·å‡½æ•° ---

        function showStatus(message, isSuccess) {
            const statusDiv = document.getElementById('status-message');
            statusDiv.innerHTML = message;
            
            const colorClass = isSuccess 
                ? 'bg-green-100 text-green-800 border-green-400' 
                : 'bg-red-100 text-red-800 border-red-400';
                
            // FIX: Use explicit string concatenation to avoid template literal issues.
            statusDiv.className = colorClass + ' p-4 mb-6 rounded-xl font-semibold shadow-md block border-l-4';
            statusDiv.style.display = 'block';
            setTimeout(() => { statusDiv.style.display = 'none'; }, 5000);
        }

        function openModal(id) {
            document.getElementById(id).style.display = 'flex';
        }

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }

        function logout() {
            window.location.assign('/logout'); 
        }
        
        function formatSpeed(kbps) {
            const rate = parseFloat(kbps);
            if (rate < 1024) return rate.toFixed(1) + ' KB/s';
            const mbps = rate / 1024;
            return mbps.toFixed(2) + ' MB/s';
        }
        
        // NEW V1: å¡«å……ç«¯å£å·åˆ° DOM
        function fillPortNumbers() {
            document.getElementById('wss-http-port').textContent = FLASK_CONFIG.WSS_HTTP_PORT;
            document.getElementById('wss-tls-port').textContent = FLASK_CONFIG.WSS_TLS_PORT;
            document.getElementById('stunnel-port').textContent = FLASK_CONFIG.STUNNEL_PORT;
            document.getElementById('udpgw-port').textContent = FLASK_CONFIG.UDPGW_PORT;
            document.getElementById('panel-port').textContent = FLASK_CONFIG.PANEL_PORT;
        }

        // --- è§†å›¾åˆ‡æ¢é€»è¾‘ ---
        
        function switchView(viewId) {
            const views = ['dashboard', 'users', 'settings', 'security', 'live-ips', 'hosts'];
            views.forEach(id => {
                const element = document.getElementById('view-' + id);
                if (element) element.style.display = (id === viewId) ? 'block' : 'none';
                
                // æ›´æ–°ä¾§è¾¹æ é“¾æ¥æ ·å¼ (Desktop)
                const navLink = document.getElementById('nav-' + id);
                if (navLink) {
                    navLink.classList.remove('bg-indigo-100', 'text-indigo-700', 'text-gray-700', 'hover:bg-gray-100');
                    if (id === viewId) {
                        navLink.classList.add('bg-indigo-100', 'text-indigo-700', 'font-bold'); // å¢å¼ºé€‰ä¸­æ ·å¼
                        navLink.classList.remove('text-gray-700', 'hover:bg-gray-100');
                    } else {
                        navLink.classList.add('text-gray-700', 'hover:bg-gray-100');
                        navLink.classList.remove('bg-indigo-100', 'text-indigo-700', 'font-bold');
                    }
                }
            });
            currentView = viewId;
            
            // åˆ·æ–°å½“å‰è§†å›¾çš„æ•°æ®
            refreshAllData();
            
            // ç‰¹æ®Šè§†å›¾çš„åˆå§‹åŒ–
            if (viewId === 'hosts') {
                fetchHosts();
            }
        }
        
        // --- æ•°æ®æ¸²æŸ“å‡½æ•° ---
        
        function renderSystemStatus(data) {
            const grid = document.getElementById('system-status-grid');
            grid.innerHTML = ''; 

            const items = [
                { name: 'CPU ä½¿ç”¨ç‡', value: data.cpu_usage.toFixed(1) + '%', color: 'border-blue-500', icon: 'âš¡' },
                { name: 'å†…å­˜ (ç”¨/æ€»)', value: data.memory_used_gb.toFixed(2) + '/' + data.memory_total_gb.toFixed(2) + 'GB', color: 'border-indigo-500', icon: 'ğŸ§ ' },
                { name: 'ç£ç›˜ä½¿ç”¨ç‡', value: data.disk_used_percent.toFixed(1) + '%', color: 'border-purple-500', icon: 'ğŸ’¾' },
                ...Object.keys(data.services).map(key => {
                    const status = data.services[key].status;
                    let color, dotClass;
                    if (status === 'running') {
                        color = 'border-green-500';
                        dotClass = 'status-active';
                    } else if (status === 'failed') {
                        color = 'border-red-500';
                        dotClass = 'status-expired';
                    } else {
                        color = 'border-yellow-500';
                        dotClass = 'status-paused';
                    }

                    return {
                        name: data.services[key].name,
                        value: data.services[key].label,
                        color: color,
                        dotClass: dotClass,
                        icon: 'ğŸ“¡'
                    };
                })
            ];

            // ä½¿ç”¨ documentFragment ä¼˜åŒ– DOM å†™å…¥æ€§èƒ½
            const fragment = document.createDocumentFragment();
            items.forEach(item => {
                const dot = item.dotClass ? '<span class="status-dot ' + item.dotClass + '"></span>' : '';
                const card = document.createElement('div');
                card.className = 'bg-white p-4 rounded-xl shadow-md border-b-4 ' + item.color + ' transition duration-300 ease-in-out hover:-translate-y-0.5 hover:shadow-xl';
                card.innerHTML = 
                    '<div class="flex items-center text-sm font-medium text-gray-500 mb-1">' +
                        item.icon + ' <span class="ml-1">' + item.name + '</span>' +
                    '</div>' +
                    '<p class="text-xl font-bold text-gray-800 flex items-center">' +
                        dot + ' ' + item.value +
                    '</p>';
                fragment.appendChild(card);
            });
            grid.innerHTML = ''; // æ¸…ç©ºåŸå§‹å†…å®¹
            grid.appendChild(fragment);
            
            renderPortStatusList(data.ports);
            renderUserQuickStats(data.user_stats);
        }
        
        function renderPortStatusList(ports) {
            const container = document.getElementById('port-status-data');
            container.innerHTML = '';
            
            const fragment = document.createDocumentFragment();
            ports.forEach(p => {
                const isListening = p.status === 'LISTEN';
                const dotClass = isListening ? 'status-active' : 'status-expired';
                const textClass = isListening ? 'text-green-600' : 'text-red-600';
                
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center text-gray-700 p-2 bg-white rounded-lg shadow-sm border border-gray-100';
                div.innerHTML = 
                    '<span class="font-medium">' + p.name + ' (' + p.port + '/' + p.protocol + '):</span>' +
                    '<span class="font-bold flex items-center ' + textClass + '">' +
                        '<span class="status-dot ' + dotClass + '"></span> ' + p.status +
                    '</span>';
                fragment.appendChild(div);
            });
             container.appendChild(fragment);
        }
        
        function renderUserQuickStats(stats) {
            const container = document.getElementById('user-quick-stats');
            container.innerHTML = 
                '<div class="bg-white p-4 rounded-xl shadow-md border-l-4 border-indigo-500 transition duration-300 ease-in-out hover:-translate-y-0.5 hover:shadow-xl">' +
                    '<p class="text-sm text-gray-500">ç”¨æˆ·æ€»æ•°</p>' +
                    '<p class="text-2xl font-bold">' + stats.total + '</p>' +
                '</div>' +
                '<div class="bg-white p-4 rounded-xl shadow-md border-l-4 border-green-500 transition duration-300 ease-in-out hover:-translate-y-0.5 hover:shadow-xl">' +
                    '<p class="text-sm text-gray-500">æ´»è·ƒç”¨æˆ·</p>' +
                    '<p class="text-2xl font-bold">' + stats.active + '</p>' +
                '</div>' +
                '<div class="bg-white p-4 rounded-xl shadow-md border-l-4 border-yellow-500 transition duration-300 ease-in-out hover:-translate-y-0.5 hover:shadow-xl">' +
                    '<p class="text-sm text-gray-500">æš‚åœ/ä¸å¯ç”¨</p>' +
                    '<p class="text-2xl font-bold">' + (stats.paused + stats.expired) + '</p>' +
                '</div>' +
                '<div class="bg-white p-4 rounded-xl shadow-md border-l-4 border-purple-500 transition duration-300 ease-in-out hover:-translate-y-0.5 hover:shadow-xl">' +
                    '<p class="text-sm text-gray-500">æ€»ç”¨é‡</p>' +
                    '<p class="text-2xl font-bold">' + stats.total_traffic_gb.toFixed(2) + ' GB</p>' +
                '</div>';
        }


        function renderUserList(users) {
            const tbody = document.getElementById('user-list-tbody');
            // ä½¿ç”¨æ•°ç»„è¿›è¡Œå­—ç¬¦ä¸²æ‹¼æ¥ï¼Œä¼˜åŒ–æ€§èƒ½
            let htmlContent = [];
            
            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="px-6 py-4 text-center text-gray-500">æš‚æ— ç”¨æˆ·è´¦å·</td></tr>';
                return;
            }

            users.forEach(user => {
                const isLocked = user.status !== 'active';
                let statusColor = 'bg-green-100 text-green-700';
                if (user.status === 'paused') { statusColor = 'bg-yellow-100 text-yellow-700'; }
                if (user.status === 'expired' || user.status === 'exceeded') { statusColor = 'bg-red-100 text-red-700'; }

                const statusText = user.status_text;
                const toggleAction = isLocked ? 'enable' : 'pause';
                const toggleText = isLocked ? 'å¯ç”¨' : 'æš‚åœ';
                const toggleColor = isLocked ? 'bg-green-500 hover:bg-green-600' : 'bg-yellow-500 hover:bg-yellow-600';
                
                const quotaLimit = user.quota_gb > 0 ? user.quota_gb : 'âˆ';
                // FIX V9: ä¿®æ­£å‰ç«¯æ˜¾ç¤ºç²¾åº¦ä¸º toFixed(4)
                const usageText = user.usage_gb.toFixed(4) + ' / ' + quotaLimit + ' GB';
                
                htmlContent.push(`
                    <tr id="row-${user.username}" class="hover:bg-gray-50 transition duration-100">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-mono text-gray-900" role="cell">${user.username}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm" role="cell">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusColor}">
                                ${statusText}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" role="cell">${user.expiration_date || 'æ°¸ä¸'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-indigo-600" role="cell">${user.active_connections}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-700" role="cell">${usageText}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-mono text-indigo-600" role="cell">${formatSpeed(user.realtime_speed)}</td>
                        <td class="px-6 py-4 text-sm font-medium" role="cell">
                            <div class="flex flex-wrap gap-1">
                                <button onclick="openSessionInfoModal('${user.username}')" 
                                        class="bg-blue-500 hover:bg-blue-600 text-white py-1.5 px-2 rounded-lg text-xs transition duration-150 shadow-sm" aria-label="ä¼šè¯è¿½è¸ª ${user.username}">ä¼šè¯è¿½è¸ª</button>
                                <button onclick="openSettingsModal('${user.username}', '${user.expiration_date || ''}', ${user.quota_gb}, '${user.rate_kbps}')" 
                                        class="bg-indigo-500 hover:bg-indigo-600 text-white py-1.5 px-2 rounded-lg text-xs transition duration-150 shadow-sm" aria-label="è®¾ç½® ${user.username}">è®¾ç½®</button>
                                <button onclick="confirmAction('${user.username}', '${toggleAction}', null, 'toggleStatus', '${toggleText}ç”¨æˆ·')" 
                                        class="${toggleColor} text-white py-1.5 px-2 rounded-lg text-xs transition duration-150 shadow-sm" aria-label="${toggleText}ç”¨æˆ· ${user.username}">${toggleText}</button>
                                <button onclick="confirmAction('${user.username}', 'delete', null, 'deleteUser', 'åˆ é™¤ç”¨æˆ·')" 
                                        class="bg-red-500 hover:bg-red-600 text-white py-1.5 px-2 rounded-lg text-xs transition duration-150 shadow-sm" aria-label="åˆ é™¤ç”¨æˆ· ${user.username}">åˆ é™¤</button>
                            </div>
                        </td>
                    </tr>
                `);
            });
            tbody.innerHTML = htmlContent.join('');
        }
        
        function renderActiveGlobalIPs(ipData) {
            const container = document.getElementById('live-ip-list');
            let htmlContent = '';
            
            if (ipData.length === 0) {
                container.innerHTML = '<p class="text-gray-500 p-2">ç›®å‰æ²¡æœ‰æ´»è·ƒçš„å¤–éƒ¨è¿æ¥ã€‚</p>';
                return;
            }

            ipData.forEach(ipInfo => {
                const isBanned = ipInfo.is_banned;
                const action = isBanned ? 'unban' : 'ban';
                const actionText = isBanned ? 'å·²å°ç¦ - è§£é™¤' : 'å…¨å±€å°ç¦';
                const buttonColor = isBanned ? 'bg-green-600 hover:bg-green-700' : 'bg-red-600 hover:bg-red-700';
                const banTag = isBanned ? '<span class="text-xs px-2 py-0.5 rounded-full ip-banned-tag ml-2">å·²å°ç¦ (é˜²ç«å¢™)</span>' : '';

                htmlContent += `
                    <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between p-3 bg-white border border-gray-200 rounded-lg shadow-sm">
                        <div class="min-w-0 flex-1 flex flex-col sm:flex-row sm:items-center">
                            <p class="font-mono text-sm text-gray-900 flex items-center">
                                <strong>${ipInfo.ip}</strong> ${banTag}
                            </p>
                        </div>
                        <button onclick="confirmAction(null, '${ipInfo.ip}', null, '${action}Global', '${isBanned ? 'è§£é™¤å…¨å±€å°ç¦' : 'å…¨å±€å°ç¦ IP'}')" 
                                     class="mt-2 sm:mt-0 w-full sm:w-auto ${buttonColor} text-white py-1.5 px-3 rounded-lg text-xs font-semibold flex-shrink-0">
                            ${actionText}
                        </button>
                    </div>`;
            });
            container.innerHTML = htmlContent;
        }
        
        function renderAuditLogs(logs) {
            const logContainer = document.getElementById('audit-log-content');
            
            // FIX P8: ç¡®ä¿åªåœ¨æ—¥å¿—ä¸ä¸ºç©ºæ—¶è¿›è¡Œè§£æï¼Œå¹¶å¤„ç† tail è¿”å›çš„ç©ºè¡Œ
            const filteredLogs = logs.filter(log => log.trim() !== "" && log !== 'è¯»å–æ—¥å¿—å¤±è´¥æˆ–æ—¥å¿—æ–‡ä»¶ä¸ºç©ºã€‚' && log !== 'æ—¥å¿—æ–‡ä»¶ä¸å­˜åœ¨ã€‚');

            if (filteredLogs.length === 0) {
                logContainer.innerHTML = '<p class="text-gray-500">ç›®å‰æ²¡æœ‰ç®¡ç†å‘˜å®¡è®¡æ´»åŠ¨æ—¥å¿—ã€‚</p>';
                return;
            }
            
            // æ¸…ç†æ—§å†…å®¹
            logContainer.innerHTML = '';
            const fragment = document.createDocumentFragment();

            filteredLogs.forEach(log => {
                // æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…æ—¥å¿—æ ¼å¼: [TIMESTAMP] [USER:...] [IP:...] ACTION:... DETAILS: ...
                const parts = log.match(/^\[(.*?)\] \[USER:(.*?)\] \[IP:(.*?)\] ACTION:(.*?) DETAILS: (.*)$/);
                
                const div = document.createElement('div');
                
                if (parts) {
                    const [_, timestamp, user, ip, action, details] = parts;
                    
                    const safeDetails = document.createElement('div');
                    safeDetails.textContent = details;
                    
                    div.className = 'text-xs text-gray-700 font-mono space-y-1 p-1 hover:bg-gray-200 rounded-md';
                    div.innerHTML = 
                        '<span class="text-indigo-600">' + timestamp.split(' ')[1] + '</span> ' +
                        '<span class="font-bold">[' + user + ']</span> ' +
                        '<span class="text-sm font-semibold text-gray-900">' + action + '</span> ' +
                        '<span class="text-gray-500">' + safeDetails.innerHTML + '</span>'; 
                } else {
                    // å¦‚æœæ ¼å¼ä¸åŒ¹é…ï¼Œç›´æ¥æ˜¾ç¤ºåŸå§‹æ—¥å¿—ï¼ˆå·²é€šè¿‡ textContent ä¿æŠ¤ï¼‰
                    div.className = 'text-xs text-gray-700 font-mono p-1';
                    div.textContent = log;
                }
                fragment.appendChild(div);
            });
            logContainer.appendChild(fragment);
        }
        
        function renderGlobalBans(bans) {
            const container = document.getElementById('global-ban-list');
            if (Object.keys(bans).length === 0) {
                container.innerHTML = '<p class="text-green-600 font-semibold p-2">ç›®å‰æ²¡æœ‰å…¨å±€å°ç¦çš„ IPã€‚</p>';
                return;
            }
            container.innerHTML = Object.keys(bans).map(ip => {
                const banInfo = bans[ip];
                return (
                    '<div class="flex justify-between items-center p-3 bg-red-50 border border-red-200 rounded-lg shadow-sm">' +
                        '<div class="font-mono text-sm text-red-700">' +
                            '<strong>' + ip + '</strong> ' +
                            '<span class="text-xs text-gray-500 ml-4">åŸå› : ' + (banInfo.reason || 'N/A') + ' (æ·»åŠ äº ' + banInfo.timestamp + ')</span>' +
                        '</div>' +
                        '<button onclick="confirmAction(null, \'' + ip + '\', null, \'unbanGlobal\', \'è§£é™¤å…¨å±€å°ç¦\')" ' +
                                     'class="bg-green-600 hover:bg-green-700 text-white py-1.5 px-3 rounded-lg text-xs font-semibold flex-shrink-0">è§£é™¤å°ç¦</button>' +
                    '</div>'
                );
            }).join('');
        }
        
        // NEW HOST FUNCTION: æ¸²æŸ“ Host åˆ—è¡¨åˆ° textarea
        function renderHosts(hosts) {
            const textarea = document.getElementById('host-list-textarea');
            const countInfo = document.getElementById('host-count-info');
            
            // å°†æ•°ç»„è½¬æ¢ä¸ºæ¢è¡Œç¬¦åˆ†éš”çš„å­—ç¬¦ä¸²
            textarea.value = hosts.join('\n');
            
            // æ›´æ–°è®¡æ•°ä¿¡æ¯
            const validHosts = hosts.filter(h => h.trim() !== '');
            countInfo.textContent = `å½“å‰åŠ è½½ ${validHosts.length} ä¸ª Hostã€‚`;
        }
        
        function renderSessionInfo(username, sessionInfo) {
            const title = document.getElementById('session-modal-username-title');
            title.textContent = username;
            
            // é‡æ–°æ¸²æŸ“æ¨¡æ€æ¡†å†…å®¹ï¼Œç¡®ä¿ä¸æ˜¾ç¤º PID
            document.getElementById('session-info-content').innerHTML = `
                <div class="text-sm text-gray-600 pt-2">
                    <p class="font-bold">å…³è”çš„å¤–éƒ¨è¿æ¥ IP (ESTAB):</p>
                    <!-- IP åˆ—è¡¨å®¹å™¨ (ä¿ç•™ ID for rendering) -->
                    <div id="session-ips" class="space-y-1 mt-2"></div>
                </div>
            `;
            const ipsDiv = document.getElementById('session-ips');

            // å°½ç®¡åç«¯è¿”å›äº† PIDï¼Œä½†æˆ‘ä»¬ä¸æ˜¾ç¤ºå®ƒï¼Œåªæ˜¾ç¤º IP åˆ—è¡¨ã€‚
            if (sessionInfo.active_ips.length === 0) {
                 ipsDiv.innerHTML = '<p class="text-red-600 font-semibold">æœªæ£€æµ‹åˆ°å…³è”çš„å¤–éƒ¨ ESTAB IPã€‚</p>'; 
            } else {
                ipsDiv.innerHTML = sessionInfo.active_ips.map(ipInfo => {
                    const isBanned = ipInfo.is_banned;
                    const action = isBanned ? 'unban' : 'ban';
                    const actionText = isBanned ? 'è§£é™¤å°ç¦' : 'å…¨å±€å°ç¦';
                    const buttonColor = isBanned ? 'bg-green-600 hover:bg-green-700' : 'bg-red-600 hover:bg-red-700';
                    const banTag = isBanned ? '<span class="text-xs px-2 py-0.5 rounded-full ip-banned-tag ml-2">å·²å°ç¦</span>' : '';

                    return '<div class="flex justify-between items-center p-2 bg-white border border-gray-200 rounded-lg shadow-sm text-xs">' +
                               '<p class="font-mono text-gray-900 flex items-center"><strong>' + ipInfo.ip + '</strong> ' + banTag + '</p>' +
                               // FIX: Global Ban button logic uses correct parameters
                               '<button onclick="confirmAction(null, \'' + ipInfo.ip + '\', null, \'' + action + 'Global\', \'' + (isBanned ? 'è§£é™¤å…¨å±€å°ç¦' : 'å…¨å±€å°ç¦ IP') + '\')" ' +
                               'class="mt-0 w-auto ' + buttonColor + ' text-white py-1 px-2 rounded-lg text-xs font-semibold flex-shrink-0">' +
                               actionText +
                               '</button>' +
                               '</div>';
                }).join('');
            }
        }

        // --- æ ¸å¿ƒ API è°ƒç”¨å‡½æ•° ---
        
        async function fetchData(url, options = {}) {
            try {
                const response = await fetch(API_BASE + url, options);
                
                // FIX P7: æ£€æŸ¥ 401 çŠ¶æ€ç ï¼Œå¦‚æœè¿”å› 401 åˆ™æ˜ç¡®å¤„ç†ï¼Œé˜²æ­¢è§£æ HTML
                if (response.status === 401) {
                    showStatus("ä¼šè¯è¿‡æœŸæˆ–æƒé™ä¸è¶³ï¼Œè¯·é‡æ–°ç™»å½•ã€‚", false);
                    window.location.assign('/login');
                    return null;
                }
                
                // Check for redirection (e.g., to /login)
                if (response.redirected) {
                    window.location.assign(response.url);
                    return null;
                }
                
                // **æ ¸å¿ƒä¿®å¤ï¼š** æ£€æŸ¥ Content-Typeï¼Œå¦‚æœä¸æ˜¯ JSON ä¸”è¯·æ±‚æ˜¯æˆåŠŸçš„ï¼ˆä½†ä¸æ˜¯é‡å®šå‘ï¼‰ï¼Œåˆ™å¯èƒ½æ˜¯ HTML é”™è¯¯
                const contentType = response.headers.get("content-type");

                if (!contentType || !contentType.includes("application/json")) {
                    if (response.ok) {
                        const text = await response.text();
                        console.error("API expected JSON but got HTML/Text:", text);
                        showStatus("API å“åº”æ ¼å¼é”™è¯¯ï¼Œå¯èƒ½è¿”å›äº† HTML é¡µé¢ã€‚", false);
                        return null;
                    }
                }
                
                const data = await response.json();
                
                if (!response.ok || !data.success) {
                    showStatus(data.message || 'API Error: ' + url, false);
                    return null;
                }
                return data;
            } catch (error) {
                showStatus('ç½‘ç»œè¯·æ±‚å¤±è´¥: ' + error.message, false);
                // æ•è·åˆ° Unexpected token '<' çš„é”™è¯¯ä¼šåœ¨è¿™é‡Œè¢«æŠ¥å‘Š
                return null;
            }
        }

        async function fetchServiceLogs(serviceId) {
            const logContainer = document.getElementById('service-log-content');
            logContainer.textContent = 'æ­£åœ¨åŠ è½½ ' + serviceId + ' æ—¥å¿—...';
            
            const data = await fetchData('/system/logs', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ service: serviceId })
            });

            if (data && data.logs) {
                logContainer.textContent = data.logs;
            } else {
                logContainer.textContent = 'æ— æ³•åŠ è½½ ' + serviceId + ' æ—¥å¿—ã€‚';
            }
        }
        
        async function fetchSessionInfo(username) {
            const data = await fetchData('/users/ip_activity?username=' + username);
            if (data && data.session_info) {
                 renderSessionInfo(username, data.session_info);
            } else {
                 renderSessionInfo(username, { sshd_pids: ['N/A'], active_ips: [] }); 
            }
        }
        
        // NEW HOST FUNCTION: è·å– Host åˆ—è¡¨
        async function fetchHosts() {
             const data = await fetchData('/settings/hosts');
             if (data && data.hosts) {
                renderHosts(data.hosts);
             } else {
                renderHosts([]);
             }
        }

        // NEW HOST FUNCTION: ä¿å­˜ Host åˆ—è¡¨
        async function saveHosts() {
            const textarea = document.getElementById('host-list-textarea');
            // å°† textarea å†…å®¹æŒ‰è¡Œåˆ†å‰²ï¼Œå¹¶è¿‡æ»¤ç©ºè¡Œ
            const hostsArray = textarea.value.split('\n').map(h => h.trim()).filter(h => h.length > 0);
            
            showStatus('æ­£åœ¨ä¿å­˜ Host é…ç½®å¹¶é‡å¯ WSS ä»£ç†...', true);
            
            const result = await fetchData('/settings/hosts', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ hosts: hostsArray })
            });

            if (result) {
                showStatus(result.message, true);
                fetchHosts(); // é‡æ–°åŠ è½½åˆ—è¡¨
            }
        }

        // --- å®æ—¶åˆ·æ–°ä¸»å‡½æ•° ---

        async function refreshAllData() {
            // 1. è·å–ç³»ç»Ÿå’Œç»„ä»¶çŠ¶æ€
            const statusData = await fetchData('/system/status');
            if (statusData) {
                renderSystemStatus(statusData);
            }

            if (currentView === 'users' || currentView === 'dashboard') {
                // 2. è·å–ç”¨æˆ·åˆ—è¡¨å’Œç»Ÿè®¡
                const usersData = await fetchData('/users/list');
                if (usersData) {
                    renderUserList(usersData.users);
                }
            }
            
            if (currentView === 'live-ips') {
                 // 3. è·å–å®æ—¶è¿æ¥ IP
                 const ipData = await fetchData('/system/active_ips');
                 if (ipData) {
                    renderActiveGlobalIPs(ipData.active_ips);
                 }
            }
            
            if (currentView === 'settings') {
                // 4. è·å–å®¡è®¡æ—¥å¿—
                // FIX P8: ç¡®ä¿è°ƒç”¨æ­£ç¡®çš„ API è·¯å¾„
                const auditData = await fetchData('/system/audit_logs');
                if (auditData) {
                    renderAuditLogs(auditData.logs);
                }
            }
            
            if (currentView === 'security') {
                // 5. è·å–å…¨å±€ IP å°ç¦åˆ—è¡¨
                const globalData = await fetchData('/ips/global_list');
                if (globalData) {
                    renderGlobalBans(globalData.global_bans);
                }
            }
            
            if (currentView === 'hosts') {
                 // 6. åˆ·æ–° Host åˆ—è¡¨
                 fetchHosts();
            }
            
            // 7. å®æ—¶åˆ·æ–°ä¼šè¯æ¨¡æ€æ¡†
            const sessionModal = document.getElementById('session-info-modal');
            if (sessionModal && sessionModal.style.display === 'flex') {
                const usernameTitle = document.getElementById('session-modal-username-title');
                if (usernameTitle) {
                    const username = usernameTitle.textContent;
                    // ä»…åœ¨æ¨¡æ€æ¡†æ‰“å¼€æ—¶åˆ·æ–°ä¼šè¯ä¿¡æ¯
                    const data = await fetchData('/users/ip_activity?username=' + username);
                    if (data && data.session_info) {
                        renderSessionInfo(username, data.session_info);
                    }
                }
            }
        }

        // --- ç”¨æˆ·æ“ä½œå®ç° ---

        document.getElementById('add-user-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const username = document.getElementById('new-username').value;
            const password = document.getElementById('new-password').value;
            const expirationDays = document.getElementById('expiration-days').value;
            const quotaGb = document.getElementById('quota-gb').value;
            const rateKbps = document.getElementById('rate-kbps').value;

            if (!/^[a-z0-9_]{3,16}$/.test(username)) {
                showStatus('ç”¨æˆ·åæ ¼å¼ä¸æ­£ç¡® (3-16ä½å°å†™å­—æ¯/æ•°å­—/ä¸‹åˆ’çº¿)', false);
                return;
            }
            
            showStatus('æ­£åœ¨åˆ›å»ºç”¨æˆ· ' + username + '...', true);

            const result = await fetchData('/users/add', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    username: username, 
                    password: password, 
                    expiration_days: parseInt(expirationDays),
                    quota_gb: parseFloat(quotaGb),
                    rate_kbps: parseInt(rateKbps)
                })
            });

            if (result) {
                showStatus(result.message, true);
                document.getElementById('add-user-form').reset();
                refreshAllData(); 
            }
        });
        
        function openSettingsModal(username, expiry_date, quota_gb, rate_kbps) {
            document.getElementById('modal-username-title-settings').textContent = username; // Note the updated ID
            document.getElementById('modal-username-setting').value = username;
            
            document.getElementById('modal-expiry-date').value = expiry_date; 
            document.getElementById('modal-quota-gb').value = quota_gb;
            document.getElementById('modal-rate-kbps').value = rate_kbps;
            document.getElementById('modal-new-password').value = '';
            
            openModal('settings-modal');
        }
        
        // FIX: openSessionInfoModal logic simplified to rely on fetchSessionInfo to open modal
        function openSessionInfoModal(username) {
            document.getElementById('session-modal-username-title').textContent = username;
            
            // Set loading state with new structure
            document.getElementById('session-info-content').innerHTML = `
                <div class="text-sm text-gray-600 pt-2">
                    <p class="font-bold">å…³è”çš„å¤–éƒ¨è¿æ¥ IP (ESTAB):</p>
                    <div id="session-ips" class="space-y-1 mt-2">æ­£åœ¨åŠ è½½ IP ä¿¡æ¯...</div>
                </div>
            `;
            
            openModal('session-info-modal'); 
            fetchSessionInfo(username); // Start fetching data
        }

        async function saveUserSettings() {
            const username = document.getElementById('modal-username-setting').value;
            const expiry_date = document.getElementById('modal-expiry-date').value;
            const quota_gb = document.getElementById('modal-quota-gb').value;
            const rate_kbps = document.getElementById('modal-rate-kbps').value;
            const new_password = document.getElementById('modal-new-password').value;
            
            closeModal('settings-modal');
            showStatus('æ­£åœ¨ä¿å­˜ç”¨æˆ· ' + username + ' çš„è®¾ç½®...', true);

            const result = await fetchData('/users/set_settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    username: username, 
                    expiry_date: expiry_date, 
                    quota_gb: parseFloat(quota_gb), 
                    rate_kbps: parseInt(rate_kbps),
                    new_ssh_password: new_password
                })
            });

            if (result) {
                showStatus(result.message, true);
                refreshAllData();
            }
        }
        
        // --- é€šç”¨ç¡®è®¤åŠæ‰§è¡Œé€»è¾‘ ---

        function confirmAction(param1, param2, param3, type, titleText) {
            let message = '';
            
            document.getElementById('confirm-param1').value = param1 || ''; // username, service, or null
            document.getElementById('confirm-param2').value = param2 || ''; // action, IP, or null
            document.getElementById('confirm-param3').value = param3 || ''; // extra param (unused)
            document.getElementById('confirm-type').value = type;
            
            const username = param1;
            const action = param2; // IP or action name
            
            if (type === 'deleteUser') {
                message = 'æ‚¨ç¡®å®šè¦æ°¸ä¹…åˆ é™¤ç”¨æˆ· <strong>' + username + '</strong> å—ï¼Ÿæ­¤æ“ä½œä¸å¯é€†ï¼Œå°†åˆ é™¤ç³»ç»Ÿè´¦æˆ·å’Œæ‰€æœ‰é…ç½®ã€‚';
            } else if (type === 'toggleStatus') {
                message = 'æ‚¨ç¡®å®šè¦ ' + (action === 'pause' ? 'æš‚åœ' : 'å¯ç”¨') + ' ç”¨æˆ· <strong>' + username + '</strong> å—ï¼Ÿ';
            } else if (type === 'serviceControl') {
                message = 'è­¦å‘Šï¼šæ‚¨ç¡®å®šè¦é‡å¯æ ¸å¿ƒæœåŠ¡ <strong>' + username + '</strong> å—ï¼Ÿè¿™å¯èƒ½ä¼šå¯¼è‡´çŸ­æš‚çš„æœåŠ¡ä¸­æ–­ã€‚';
            } else if (type === 'unbanGlobal') {
                message = 'æ‚¨ç¡®å®šè¦è§£é™¤å…¨å±€å°ç¦ IP åœ°å€ <strong>' + action + '</strong> å—ï¼Ÿ';
                closeModal('session-info-modal'); // å¦‚æœä»ä¼šè¯æ¨¡æ€æ¡†å‘èµ·æ“ä½œï¼Œå…ˆå…³é—­å®ƒ
            } else if (type === 'banGlobal') {
                message = 'æ‚¨ç¡®å®šè¦å¯¹ IP åœ°å€ <strong>' + action + '</strong> æ‰§è¡Œå…¨å±€å°ç¦æ“ä½œå—ï¼Ÿ';
                closeModal('session-info-modal'); // å¦‚æœä»ä¼šè¯æ¨¡æ€æ¡†å‘èµ·æ“ä½œï¼Œå…ˆå…³é—­å®ƒ
            } else if (type === 'resetTraffic') {
                message = 'è­¦å‘Šï¼šæ‚¨ç¡®å®šè¦å°†ç”¨æˆ· <strong>' + username + '</strong> çš„æµé‡ä½¿ç”¨é‡è®¡æ•°å™¨é‡ç½®ä¸º 0 å—ï¼Ÿ';
            } else if (type === 'killAll') {
                message = 'è­¦å‘Šï¼šæ‚¨ç¡®å®šè¦å¼ºåˆ¶æ–­å¼€ç”¨æˆ· <strong>' + username + '</strong> çš„æ‰€æœ‰æ´»è·ƒè¿æ¥å—ï¼Ÿè¿™ä¼šå¼ºåˆ¶ç”¨æˆ·é‡æ–°è¿æ¥ã€‚';
                closeModal('session-info-modal');
            }

            document.getElementById('confirm-title').textContent = titleText;
            document.getElementById('confirm-message').innerHTML = message;
            
            const confirmBtn = document.getElementById('confirm-action-btn');
            
            if (type.includes('ban') || type === 'deleteUser' || type === 'serviceControl' || type === 'killAll') {
                 confirmBtn.className = 'bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-200';
            } else if (type.includes('enable') || type === 'unbanGlobal' || type === 'resetTraffic') {
                 confirmBtn.className = 'bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-200';
            } else {
                 confirmBtn.className = 'bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-200';
            }

            confirmBtn.onclick = executeAction;
            
            openModal('confirm-modal');
        }

        async function executeAction() {
            closeModal('confirm-modal');
            
            // ä»éšè—å­—æ®µè¯»å–å‚æ•°
            const param1 = document.getElementById('confirm-param1').value;
            const param2 = document.getElementById('confirm-param2').value;
            const type = document.getElementById('confirm-type').value;

            showStatus('æ­£åœ¨æ‰§è¡Œ ' + type + ' æ“ä½œ...', true);

            let url;
            let body = {};

            if (type === 'deleteUser') {
                url = '/users/delete';
                body = { username: param1 };
            } else if (type === 'toggleStatus') {
                url = '/users/status';
                body = { username: param1, action: param2 }; // param2 is action (enable/pause)
            } else if (type === 'resetTraffic') {
                url = '/users/reset_traffic';
                body = { username: param1 };
            } else if (type === 'serviceControl') {
                url = '/system/control';
                body = { service: param1, action: param2 }; // param1: service, param2: action
            } else if (type === 'unbanGlobal') {
                url = '/ips/unban_global';
                body = { ip: param2 }; // param2: IP
            } else if (type === 'banGlobal') {
                url = '/ips/ban_global';
                body = { ip: param2, reason: 'Manual Global Ban' }; // param2: IP
            } else if (type === 'killAll') {
                url = '/users/kill_all';
                body = { username: param1 };
            }

            const result = await fetchData(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });

            if (result) {
                showStatus(result.message, true);
                
                // ç³»ç»Ÿæ§åˆ¶æˆ–ä¸»ç”¨æˆ·åˆ—è¡¨çš„åˆ·æ–° (å»¶è¿Ÿåˆ·æ–°ä»¥ç­‰å¾…ç³»ç»Ÿå‘½ä»¤ç”Ÿæ•ˆ)
                if (type === 'serviceControl' || type === 'deleteUser' || type === 'toggleStatus' || type === 'unbanGlobal' || type === 'banGlobal' || type === 'resetTraffic' || type === 'killAll') {
                    setTimeout(refreshAllData, 2000); 
                }
            }
        }
        
        document.getElementById('add-global-ban-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const ip = document.getElementById('global-ban-ip').value;
            
            if (!ip) return showStatus('IP åœ°å€ä¸èƒ½ä¸ºç©º', false);
            
            confirmAction(null, ip, null, 'banGlobal', 'å…¨å±€å°ç¦ IP');
        });


        // --- å¯åŠ¨è„šæœ¬ ---
        
        window.onload = function() {
            // NEW V1: å¡«å……ç«¯å£å·
            fillPortNumbers();
            
            // ç¡®ä¿é»˜è®¤é€‰ä¸­çŠ¶æ€æ­£ç¡®åº”ç”¨
            const defaultNav = document.getElementById('nav-dashboard');
            if (defaultNav) {
                defaultNav.classList.add('bg-indigo-100', 'text-indigo-700', 'font-bold');
                defaultNav.classList.remove('text-gray-700', 'hover:bg-gray-100');
            }

            // ç¡®ä¿ç§»åŠ¨ç«¯ä¸‹æ‹‰æ¡†é€‰ä¸­æ­£ç¡®çš„åˆå§‹å€¼
            const mobileSelect = document.getElementById('mobile-view-select');
            if (mobileSelect) {
                mobileSelect.value = 'dashboard';
            }

            switchView('dashboard');
            setInterval(refreshAllData, 10000); 
        };

    </script>
</body>
</html>
